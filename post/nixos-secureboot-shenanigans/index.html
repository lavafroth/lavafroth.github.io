<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>NixOS Secureboot Shenanigans - lavafroth</title><meta name=description content="Key takeaways

This issue only pertains to secureboot on NixOS using lanzaboote. Most Linux users have secureboot disabled. If you are paranoid like me and have enabled it, continue reading.
Make sure to track the latest version of lanzaboote. (example)
Set the PKI bundle location to the newer sbctl default. (example)

Deprecated overrideScope'
For the past few months, I started noticing this new warning when rebuilding my system with nixos-rebuild."><meta name=author content><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/app.min.css><link rel=preload as=image href=../../header.svg><link as=font href=https://lavafroth.is-a.dev/latinmodern-math.otf><link rel=preload as=image href=https://lavafroth.is-a.dev/github.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/about.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/art.svg><link rel=icon href=https://lavafroth.is-a.dev/favicon.png><link rel=blog-icon href=https://lavafroth.is-a.dev/icon.png></head><body data-menu=true><header class=header><h1><a class=site-name href=https://lavafroth.is-a.dev/><svg viewBox="0 0 8790 2400"><path d="M80 1935V465h216v1270h286v2e2zm853 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm1025 528L2014 465h210l108 868 8 142h12l8-142 108-868h210l-224 1470zm813 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm851 528V465h514v222h-298v386h2e2v222h-2e2v640zm910 0V465h216q194 0 286 108 92 107 92 316 0 124-43 215-44 90-106 132l147 699h-216l-122-620h-38v620zm216-820q60 0 95-26 35-27 50-76t15-116q0-105-34-161-35-57-126-57zm1084 836q-90 0-154-42-65-42-99-114-35-72-35-162V767q0-91 35-162 34-72 99-114 64-42 154-42t155 42q64 42 99 114 34 72 34 162v866q0 90-34 162-35 72-99 114-65 42-155 42zm0-210q40 0 56-33 16-34 16-75V767q0-41-17-74-17-34-55-34-37 0-54 34-18 33-18 74v866q0 41 17 75 17 33 55 33zm890 194V687h-204V465h624v222h-204v1248zm828 0V465h216v608h168V465h216v1470h-216v-640h-168v640z"/></svg></a></h1><div class=push></div><a style=--url:url(./github.svg) href=https://github.com/lavafroth aria-label=github target=_blank></a><a href=../../about/ aria-label=about style=--url:url(./about.svg)></a><a href=../../art/ aria-label=art style=--url:url(./art.svg)></a></header><main class=main><article class=post-single data-pagefind-body><header class=post-title><p data-pagefind-ignore><time>Dec 20, 2024 | 3 minutes read</time></p><h1 data-pagefind-meta=title>NixOS Secureboot Shenanigans</h1></header><section class=post-content><h1 id=key-takeaways>Key takeaways</h1><ul><li>This issue only pertains to secureboot on NixOS using lanzaboote. Most Linux users have secureboot disabled. If you are paranoid like me and have enabled it, continue reading.</li><li>Make sure to track the latest version of <code>lanzaboote</code>. (<a href=https://github.com/lavafroth/dotfiles/commit/4d64808ffbc135b5bf5a61df17ef02d7da8452b7>example</a>)</li><li>Set the PKI bundle location to the newer <code>sbctl</code> default. (<a href=https://github.com/lavafroth/dotfiles/commit/1fa71734bb3af83b8de9134e68f0153f49a18205>example</a>)</li></ul><h1 id=deprecated-overridescope>Deprecated <code>overrideScope'</code></h1><p>For the past few months, I started noticing this new warning when rebuilding my system with <code>nixos-rebuild</code>.</p><pre tabindex=0><code>warning: `overrideScope&#39;` will be deprecated soon
</code></pre><p>I thought nothing of it since NixOS sometimes has these small spans of time when things are being migrated.</p><p>A couple days ago, I bumped my flake with <code>nix flake update</code> and this somewhat longstanding warning turned into
and error.</p><pre tabindex=0><code>error: attribute &#39;overrideScope&#39;&#39; missing
</code></pre><p>After a bit of digging around I discovered that the problem was caused due the out-of-date <code>crane</code> dependency
required for <a href=https://github.com/nix-community/lanzaboote/><code>lanzaboote</code></a>, the Rust utility for the secure boot shim<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. After looking through <a href=https://github.com/nix-community/lanzaboote/issues/411>this issue on github</a>
as well as the lanzaboote repository, it dawned on me that I had been using a version of lanzaboote released even before July this year.</p><p>This meant I had to update the version in my <code>flake.nix</code> inputs like so</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>     lanzaboote = {
</span></span><span style=display:flex><span><span style=color:#f92672>-      url = &#34;github:nix-community/lanzaboote/v0.3.0&#34;;
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+      url = &#34;github:nix-community/lanzaboote/v0.4.1&#34;;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>       inputs.nixpkgs.follows = &#34;nixpkgs&#34;;
</span></span><span style=display:flex><span>     };
</span></span></code></pre></div><p>With that, I ran another <code>nix flake update</code> and enqueued my system for a rebuild.
I deleted a few entries from <code>/boot/EFI/nixos</code> because the <a href=https://github.com/nix-community/lanzaboote/releases/tag/v0.4.1>new release</a> uses double the scratch space as needed by the previous version. Also, I had around 16 older generations of my setup for the sake of posteriety.</p><h1 id=where-is-the-pki-bundle>Where is the PKI Bundle?</h1><p>The rebuild led to yet another error, this time concerning a nonexistent path.</p><pre tabindex=0><code>Installing Lanzaboote to &#34;/boot&#34;...
Failed to install generation 303: Get stub name: No such file or directory (os error 2)
Failed to install bootloader
warning: error(s) occurred while switching to the new configuration
</code></pre><p>The hardest part of debugging this was to know what program was causing this issue and what path it was looking for.
Fortunately, we can use <code>strace</code> to see what system calls are being made by <code>nixos-rebuild</code>. We also add the <code>-f</code> flag to follow the system
calls of child processes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo strace -f nixos-rebuild boot --flake /home/h/Public/dotfiles#cafe
</span></span></code></pre></div><p>From the obscenely long logs which I will spare you from reading, one could observe that the secureboot key management tool <code>sbctl</code>
looks for the path <code>/var/lib/sbctl</code>. This correlates with <a href=https://github.com/nix-community/lanzaboote/issues/413>this issue</a> and <a href=https://github.com/Foxboron/sbctl/blob/cd6dd1c6a02f5b4b3b93669e78671b656ddcfe67/config/config.go#L107C19-L107C34>this commit</a> confirming that <code>sbctl</code> has switched the default
public key infrastructure bundle (<code>pkiBundle</code>) location to <code>/var/lib/sbctl</code>.</p><p>I finally solved the issue by setting the respective parameter in my config.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>boot<span style=color:#f92672>.</span>lanzaboote <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  pkiBundle <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/var/lib/sbctl&#34;</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>I recommend performing garbage collection on your system before queueing another rebuild because the last error
causes you to land in a generation that is unavailable in the systemd-boot menu.</p><p>Honestly, I think this whole issue would have been much easier to resolve if <code>sbctl</code> spelled out the path it was looking for in the error message.</p><p>Anyways, that&rsquo;s all for today, hope this helps!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>I have two NixOS outputs defined for my work setup, one with secureboot and another without. See my system config <a href=https://github.com/lavafroth/dotfiles>here</a>.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></section></article><footer class=post-tags data-pagefind-meta=tags><a href=https://lavafroth.is-a.dev/tags/nix class=list-tag>Nix</a>
<a href=https://lavafroth.is-a.dev/tags/nixos class=list-tag>NixOS</a>
<a href=https://lavafroth.is-a.dev/tags/secureboot class=list-tag>Secureboot</a>
<a href=https://lavafroth.is-a.dev/tags/sbctl class=list-tag>sbctl</a>
<a href=https://lavafroth.is-a.dev/tags/lanzaboote class=list-tag>lanzaboote</a>
<a href=https://lavafroth.is-a.dev/tags/debugging class=list-tag>Debugging</a></footer><nav class=post-nav><a class=prev href=https://lavafroth.is-a.dev/post/a-tale-of-a-frugal-home-server/><span>←</span><span>A Tale of a Frugal Home Server</span></a>
<a class=next href=https://lavafroth.is-a.dev/post/the-gsoc-grand-finale/><span>Wrapping up GSoC 2024</span><span>→</span></a></nav></main><footer class=footer><p>&copy; 2025 <a href=https://lavafroth.is-a.dev/>lavafroth</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/issues/new/choose>Report an issue</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/discussions/>Discuss</a></p><p><a href=https://lavafroth.is-a.dev/privacy>Privacy</a></p><p><a href=https://creativecommons.org/licenses/by-sa/4.0/legalcode>License</a></p></footer></body></html>