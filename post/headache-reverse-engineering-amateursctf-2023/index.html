<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Headache - lavafroth</title><meta name=description content='This challenge involves reverse engineering a polymorphic binary, one that modifies its own instructions during runtime.
Essentially, the binary checks if the current character equals a known value and xor decrypts the next section where the
code jumps to. If the characters don&rsquo;t match, the logic short-circuits and the program exits.
This process of checking the character and decrypting the next branch continues like opening up a Matryoshka doll until
the last branch which returns instead of calling the decryption subroutine.'><meta name=author content><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/app.min.css><link rel="preload stylesheet" href=../../header.svg><noscript><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/noscript.min.css></noscript><link rel=preload as=font href=https://lavafroth.is-a.dev/LeagueGothic.ttf><link as=font href=https://lavafroth.is-a.dev/latinmodern-math.otf><link rel=preload as=image href=https://lavafroth.is-a.dev/github.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/about.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/art.svg><link rel=icon href=https://lavafroth.is-a.dev/favicon.png><link rel=blog-icon href=https://lavafroth.is-a.dev/icon.png></head><body class=not-ready data-menu=true><header class=header><h1><a class=site-name href=https://lavafroth.is-a.dev/>lavafroth</a></h1><svg id="btnDark" class="btn-dark" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 60 60" preserveAspectRatio="xMinYMin meet"><path class="circle" d="M30 16c7.73.0 14 6.27 14 14 0 3.81-1.53 7.27-4 9.8-2.54 2.59-6.08 4.2-10 4.2-7.73.0-14-6.27-14-14 0-7.73 6.27-14 14-14z"/><g class="rays" data-svg-origin="30 30"><line class="line" x1="30" y1="11" x2="30" y2="7"/><line class="line" x1="43.44" y1="16.57" x2="46.26" y2="13.74"/><line class="line" x1="49" y1="30" x2="53" y2="30"/><line class="line" x1="43.43" y1="43.44" x2="46.26" y2="46.26"/><line class="line" x1="30" y1="49" x2="30" y2="53"/><line class="line" x1="16.56" y1="43.43" x2="13.74" y2="46.26"/><line class="line" x1="11" y1="30" x2="7" y2="30"/><line class="line" x1="16.57" y1="16.56" x2="13.74" y2="13.74"/></g></svg><div class=space></div><a style=--url:url(./github.svg) href=https://github.com/lavafroth aria-label=github target=_blank></a><a href=../../about/ aria-label=about style=--url:url(./about.svg)></a><a href=../../art/ aria-label=art style=--url:url(./art.svg)></a><script>const bodyClx=document.body.classList,sysDark=window.matchMedia("(prefers-color-scheme: dark)"),darkVal=localStorage.getItem("dark"),setDark=e=>(bodyClx.toggle("dark",e),localStorage.setItem("dark",e));setDark(darkVal?darkVal==="true":sysDark.matches),requestAnimationFrame(()=>bodyClx.remove("not-ready")),btnDark.addEventListener("click",()=>setDark(!bodyClx.contains("dark"))),sysDark.addEventListener("change",({matches:e})=>setDark(e))</script></header><main class=main><article class=post-single><header class=post-title><p><time>Sep 7, 2023 | 3 minutes read</time></p><h1 data-pagefind-meta=title>Headache</h1></header><section class=post-content data-pagefind-body><p>This challenge involves reverse engineering a polymorphic binary, one that modifies its own instructions during runtime.</p><p>Essentially, the binary checks if the current character equals a known value and <em>xor</em> decrypts the next section where the
code jumps to. If the characters don&rsquo;t match, the logic short-circuits and the program exits.</p><p>This process of checking the character and decrypting the next branch continues like opening up a Matryoshka doll until
the last branch which returns instead of calling the decryption subroutine.</p><p>To begin, we need to have radare2 installed. Next, we will create a Python virtual environment and install the r2pipe package.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python -m venv env
</span></span><span style=display:flex><span>source env/bin/activate <span style=color:#75715e># or activate.fish in my case</span>
</span></span><span style=display:flex><span>pip install r2pipe
</span></span></code></pre></div><p>We download the <code>headache</code> binary and place the following script in our working directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> shutil
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> binascii
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> r2pipe
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> dataclasses <span style=color:#f92672>import</span> dataclass
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> struct
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> Optional
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(<span style=color:#e6db74>&#39;headache_patched&#39;</span>):
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>unlink(<span style=color:#e6db74>&#34;headache_patched&#34;</span>)
</span></span><span style=display:flex><span>shutil<span style=color:#f92672>.</span>copy(<span style=color:#e6db74>&#39;headache&#39;</span>, <span style=color:#e6db74>&#39;headache_patched&#39;</span>)
</span></span><span style=display:flex><span>r2 <span style=color:#f92672>=</span> r2pipe<span style=color:#f92672>.</span>open(<span style=color:#e6db74>&#34;headache_patched&#34;</span>, flags<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;-w&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@dataclass</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Formula</span>:
</span></span><span style=display:flex><span>    a: int
</span></span><span style=display:flex><span>    b: int
</span></span><span style=display:flex><span>    xor: int
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>apply</span>(self, flag):
</span></span><span style=display:flex><span>        a_exists <span style=color:#f92672>=</span> flag[self<span style=color:#f92672>.</span>a] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        b_exists <span style=color:#f92672>=</span> flag[self<span style=color:#f92672>.</span>b] <span style=color:#f92672>is</span> <span style=color:#f92672>not</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> a_exists <span style=color:#f92672>and</span> <span style=color:#f92672>not</span> b_exists:
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> flag[self<span style=color:#f92672>.</span>a] <span style=color:#f92672>^</span> self<span style=color:#f92672>.</span>xor
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> valid_character(result):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>            flag[self<span style=color:#f92672>.</span>b] <span style=color:#f92672>=</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> b_exists <span style=color:#f92672>and</span> <span style=color:#f92672>not</span> a_exists:
</span></span><span style=display:flex><span>            result <span style=color:#f92672>=</span> flag[self<span style=color:#f92672>.</span>b] <span style=color:#f92672>^</span> self<span style=color:#f92672>.</span>xor
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> valid_character(result):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>            flag[self<span style=color:#f92672>.</span>a] <span style=color:#f92672>=</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>unravel</span>(base: int) <span style=color:#f92672>-&gt;</span> (int, Optional[Formula]):
</span></span><span style=display:flex><span>    r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;af-&#34;</span>)
</span></span><span style=display:flex><span>    r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;s </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(hex(base)))
</span></span><span style=display:flex><span>    r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;af&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    pdr <span style=color:#f92672>=</span> r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;pi 10&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;s +3&#34;</span>)
</span></span><span style=display:flex><span>        exec(r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;pcp 1&#34;</span>), globals())
</span></span><span style=display:flex><span>        a <span style=color:#f92672>=</span> ord(buf)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;s +3&#34;</span>)
</span></span><span style=display:flex><span>        b <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        exec(r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;pcp 1&#34;</span>), globals())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> buf <span style=color:#f92672>==</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x7f</span><span style=color:#e6db74>&#39;</span>:
</span></span><span style=display:flex><span>            r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;s +1&#34;</span>)
</span></span><span style=display:flex><span>            exec(r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;pcp 1&#34;</span>), globals())
</span></span><span style=display:flex><span>            b <span style=color:#f92672>=</span> ord(buf)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;s +4&#34;</span>)
</span></span><span style=display:flex><span>        exec(r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;pcp 1&#34;</span>), globals()) 
</span></span><span style=display:flex><span>        x <span style=color:#f92672>=</span> ord(buf)
</span></span><span style=display:flex><span>        f <span style=color:#f92672>=</span> Formula(a, b, x)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        base, <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    jump_index <span style=color:#f92672>=</span> pdr<span style=color:#f92672>.</span>find(<span style=color:#e6db74>&#34;je &#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    pdr <span style=color:#f92672>=</span> pdr[jump_index <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>:]
</span></span><span style=display:flex><span>    other_block <span style=color:#f92672>=</span> pdr[:<span style=color:#ae81ff>8</span>]
</span></span><span style=display:flex><span>    r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;s 0x&#34;</span> <span style=color:#f92672>+</span> other_block)
</span></span><span style=display:flex><span>    r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;af-&#34;</span>)
</span></span><span style=display:flex><span>    r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;af&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># mov eax == b8 (one byte)</span>
</span></span><span style=display:flex><span>    r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;s +1&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    exec(r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;pcp 4&#34;</span>), globals())
</span></span><span style=display:flex><span>    xor_key <span style=color:#f92672>=</span> buf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;s +8&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e># lea address is now in buf</span>
</span></span><span style=display:flex><span>    exec(r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;pcp 4&#34;</span>), globals())
</span></span><span style=display:flex><span>    mutating_fn <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&lt;I&#34;</span>, buf)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> mutating_fn <span style=color:#f92672>==</span> <span style=color:#ae81ff>0xffffffff</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> base, <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;s &#34;</span> <span style=color:#f92672>+</span> hex(mutating_fn))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        exec(r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;pcp 4&#34;</span>), globals())
</span></span><span style=display:flex><span>        recovered <span style=color:#f92672>=</span> bytearray(x <span style=color:#f92672>^</span> y <span style=color:#66d9ef>for</span> x, y <span style=color:#f92672>in</span> zip(buf, xor_key))
</span></span><span style=display:flex><span>        unpacked <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>unpack(<span style=color:#e6db74>&#34;&lt;I&#34;</span>, recovered)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#39;wv </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(unpacked))
</span></span><span style=display:flex><span>        r2<span style=color:#f92672>.</span>cmd(<span style=color:#e6db74>&#34;s +4&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> recovered <span style=color:#f92672>==</span> xor_key:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mutating_fn, f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>formulas <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>next_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x401290</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> next_addr <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0x40261c</span>:
</span></span><span style=display:flex><span>    next_addr, formula <span style=color:#f92672>=</span> unravel(next_addr)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> formula <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        r2<span style=color:#f92672>.</span>quit()
</span></span><span style=display:flex><span>        r2 <span style=color:#f92672>=</span> r2pipe<span style=color:#f92672>.</span>open(<span style=color:#e6db74>&#34;headache_patched&#34;</span>, flags<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;-w&#39;</span>])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>    print(hex(next_addr))
</span></span><span style=display:flex><span>    formulas<span style=color:#f92672>.</span>append(formula)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>charset <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>valid_character</span>(c: int):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> c <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>256</span> <span style=color:#f92672>and</span> chr(c) <span style=color:#f92672>in</span> charset
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>flag <span style=color:#f92672>=</span> [<span style=color:#66d9ef>None</span>] <span style=color:#f92672>*</span> <span style=color:#ae81ff>61</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i, c <span style=color:#f92672>in</span> enumerate(map(ord, <span style=color:#e6db74>&#34;amateursCTF{&#34;</span>)):
</span></span><span style=display:flex><span>    flag[i] <span style=color:#f92672>=</span> c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>flag[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> ord(<span style=color:#e6db74>&#39;}&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#f92672>not</span> all(flag):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> formula <span style=color:#f92672>in</span> formulas:
</span></span><span style=display:flex><span>        formula<span style=color:#f92672>.</span>apply(flag)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(map(chr, flag)))
</span></span></code></pre></div><p>Note that we begin our binary parsing from the address <code>0x401290</code> since that is where the first condition and subsequent decryptions begin.
We also allocate a list of 61 <code>None</code> singletons since the program exits if the input has a length other than 61.</p><p>Finally, we can run our script.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python main.py
</span></span></code></pre></div><p>Since Python is quite slow and my solution is not elegant, it will take anywhere between 2 to 4 minutes to decrypt all the sections. After this, we get the flag.</p><pre tabindex=0><code>amateursCTF{i_h4v3_a_spli77ing_headache_1_r3qu1re_m04r_sl33p}
</code></pre></section></article><footer class=post-tags data-pagefind-meta=tags><a href=https://lavafroth.is-a.dev/tags/amateursctf class=list-tag>AmateursCTF</a>
<a href=https://lavafroth.is-a.dev/tags/ctf class=list-tag>CTF</a>
<a href=https://lavafroth.is-a.dev/tags/reverse-engineering class=list-tag>Reverse Engineering</a></footer><nav class=post-nav><a class=prev href=https://lavafroth.is-a.dev/post/abstracting-structured-patterns-in-concurrent-programming/><span>←</span><span>Abstracting Structured Patterns in Concurrent Programming</span></a>
<a class=next href=https://lavafroth.is-a.dev/post/compact-xor-crypto-challenge-amateursctf-2023/><span>Compact XOR</span><span>→</span></a></nav></main><footer class=footer><p>&copy; 2025 <a href=https://lavafroth.is-a.dev/>lavafroth</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/issues/new/choose>Report an issue</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/discussions/>Discuss</a></p><p><a href=https://lavafroth.is-a.dev/privacy>Privacy</a></p><p><a href=https://creativecommons.org/licenses/by-sa/4.0/legalcode>License</a></p></footer></body></html>