<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Working With LUKS File Stashes - lavafroth</title><meta name=description content='LUKS is an incredible solution for encrypting entire partitions in Linux.
Often times, however, we can&rsquo;t afford to create new partitions inside a disk
without having to completely format the drive anew.
This post will guide you through the process of creating and working
with LUKS container files that are encrypted at rest and can be decrypted on
demand with knowledge of the passphrase.
Creating the image base
head --bytes=4G /dev/urandom > stash.img
Format the image
The image can be formatted by either including the header in the image itself or
keeping a detached header.'><meta name=author content><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/app.min.css><link rel=preload as=image href=../../header.svg><link as=font href=https://lavafroth.is-a.dev/latinmodern-math.otf><link rel=preload as=image href=https://lavafroth.is-a.dev/github.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/about.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/art.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/rss.svg><link rel=icon href=https://lavafroth.is-a.dev/favicon.png><link rel=blog-icon href=https://lavafroth.is-a.dev/icon.png></head><body><header><a class=site-name href=https://lavafroth.is-a.dev/><svg viewBox="0 0 8790 2080"><path d="M80 1935V465h216v1270h286v2e2zm853 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm1025 528L2014 465h210l108 868 8 142h12l8-142 108-868h210l-224 1470zm813 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm851 528V465h514v222h-298v386h2e2v222h-2e2v640zm910 0V465h216q194 0 286 108 92 107 92 316 0 124-43 215-44 90-106 132l147 699h-216l-122-620h-38v620zm216-820q60 0 95-26 35-27 50-76t15-116q0-105-34-161-35-57-126-57zm1084 836q-90 0-154-42-65-42-99-114-35-72-35-162V767q0-91 35-162 34-72 99-114 64-42 154-42t155 42q64 42 99 114 34 72 34 162v866q0 90-34 162-35 72-99 114-65 42-155 42zm0-210q40 0 56-33 16-34 16-75V767q0-41-17-74-17-34-55-34-37 0-54 34-18 33-18 74v866q0 41 17 75 17 33 55 33zm890 194V687h-204V465h624v222h-204v1248zm828 0V465h216v608h168V465h216v1470h-216v-640h-168v640z"/></svg></a><nav><a style=--url:url(./github.svg) href=https://github.com/lavafroth aria-label=github target=_blank></a><a href=../../about/ aria-label=about style=--url:url(./about.svg)></a><a href=../../art/ aria-label=art style=--url:url(./art.svg)></a><a href=../../index.xml aria-label=rss style=--url:url(./rss.svg)></a><nav></header><main><hgroup data-pagefind-body><p data-pagefind-ignore><time>Jan 1, 2026 | 2 minutes read</time></p><h1 data-pagefind-meta=title>Working With LUKS File Stashes</h1></hgroup><section class=post-content data-pagefind-body><p>LUKS is an incredible solution for encrypting entire partitions in Linux.
Often times, however, we can&rsquo;t afford to create new partitions inside a disk
without having to completely format the drive anew.</p><p>This post will guide you through the process of creating and working
with LUKS container files that are encrypted at rest and can be decrypted on
demand with knowledge of the passphrase.</p><h2 id=creating-the-image-base>Creating the image base</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>head --bytes<span style=color:#f92672>=</span>4G /dev/urandom &gt; stash.img
</span></span></code></pre></div><h2 id=format-the-image>Format the image</h2><p>The image can be formatted by either including the header in the image itself or
keeping a detached header.</p><p>In either case, cryptsetup will ask for passphrase which will secure
the contents of this container.</p><h3 id=including-the-luks-header>Including the LUKS header</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cryptsetup luksFormat stash.img
</span></span></code></pre></div><h3 id=with-a-detached-luks-header>With a detached LUKS header</h3><blockquote><p>Note: Using a detached LUKS header is unsupported by udisksctl. Mounting such images
can only be done using <code>cryptsetup</code> with super user privileges.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cryptsetup luksFormat stash.img --header stash.img.luks
</span></span></code></pre></div><h2 id=formatting-the-drive-with-a-filesystem>Formatting the drive with a filesystem</h2><p>Super user privileges are required for this action. Run the following as root.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mkdir -p /mnt/stash
</span></span><span style=display:flex><span>cryptsetup open stash.img stash <span style=color:#75715e># --header stash.img.luks</span>
</span></span><span style=display:flex><span>mkfs.ext4 /dev/mapper/stash
</span></span><span style=display:flex><span>mount /dev/mapper/stash /mnt/stash
</span></span><span style=display:flex><span>chown -R :users /mnt/stash
</span></span><span style=display:flex><span>chmod -R g+rw /mnt/stash
</span></span><span style=display:flex><span>umount /mnt/stash
</span></span><span style=display:flex><span>cryptsetup close stash
</span></span></code></pre></div><h2 id=interacting-with-the-image>Interacting with the image</h2><p>This section shall describe mounting and unmounting the stash both with and without
super user privileges, although, I suppose most readers will be interested in latter
since that&rsquo;s the whole point of portable LUKS file stashes.</p><h3 id=with-super-user-privileges>With super user privileges</h3><h4 id=mounting>Mounting</h4><p>The following commands will</p><ul><li>Create a mountpoint at <code>/mnt/stash</code></li><li>Open the image with <code>cryptsetup</code> as <code>/dev/mapper/stash</code></li><li>Mount the the mapper device to the mountpoint</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mkdir -p /mnt/stash
</span></span><span style=display:flex><span>cryptsetup open stash.img stash <span style=color:#75715e># --header stash.img.luks</span>
</span></span><span style=display:flex><span>mount /dev/mapper/stash /mnt/stash
</span></span></code></pre></div><h4 id=unmounting>Unmounting</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>umount /dev/mapper/stash
</span></span><span style=display:flex><span>cryptsetup close stash
</span></span></code></pre></div><h3 id=without-super-user-privileges>Without super user privileges</h3><h4 id=mounting-1>Mounting</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>udisksctl loop-setup --file stash.img
</span></span></code></pre></div><p>This returns the path to a loop device, for example, <code>/dev/loop0</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>udisksctl unlock --block-device /dev/loop0
</span></span></code></pre></div><p>Enter the passphrase previously used for formatting the image. The drive should be accessible via a graphical file manager.</p><h4 id=unmounting-1>Unmounting</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>udisksctl lock --block-device /dev/loop0
</span></span><span style=display:flex><span>udisksctl loop-delete --block-device /dev/loop0
</span></span></code></pre></div></section><footer class=post-tags data-pagefind-meta=tags><a href=https://lavafroth.is-a.dev/tags/linux class=list-tag>Linux</a>
<a href=https://lavafroth.is-a.dev/tags/luks class=list-tag>LUKS</a>
<a href=https://lavafroth.is-a.dev/tags/cryptography class=list-tag>Cryptography</a></footer><nav data-post><br><a href=https://lavafroth.is-a.dev/post/algebraic-python-enums/><span>Algebraic Python Enums</span><span>â†’</span></a></nav></main><footer class=footer><p>&copy; 2026 <a href=https://lavafroth.is-a.dev/>lavafroth</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/issues/new/choose>Report an issue</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/discussions/>Discuss</a></p><p><a href=https://lavafroth.is-a.dev/privacy>Privacy</a></p><p><a href=https://creativecommons.org/licenses/by-sa/4.0/legalcode>License</a></p></footer></body></html>