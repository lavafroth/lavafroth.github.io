<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Modes, Unbinds and Other Ensembled Parser Patterns - lavafroth</title><meta name=description content='Hello and welcome to the sixth instalment in this series where we build a parser
for a domain specific language from scratch. I would highly recommend you to go
through the previous articles to make sense of what we&rsquo;ll talk about today.
So far, we have built ranges, shorthands and bindings, starting all the way down
from primitives such as keys and modifiers. Continuing with the theme, we will
ensemble these patterns together along with some newer syntax to build modes.'><meta name=author content><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/app.min.css><link rel=preload as=image href=../../header.svg><noscript><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/noscript.min.css></noscript><link rel=preload as=font href=https://lavafroth.is-a.dev/LeagueGothic.ttf><link as=font href=https://lavafroth.is-a.dev/latinmodern-math.otf><link rel=preload as=image href=https://lavafroth.is-a.dev/github.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/about.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/art.svg><link rel=icon href=https://lavafroth.is-a.dev/favicon.png><link rel=blog-icon href=https://lavafroth.is-a.dev/icon.png></head><body class=not-ready data-menu=true><header class=header><h1><a class=site-name href=https://lavafroth.is-a.dev/>lavafroth</a></h1><svg id="btnDark" class="btn-dark" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 60 60" preserveAspectRatio="xMinYMin meet"><path class="circle" d="M30 16c7.73.0 14 6.27 14 14 0 3.81-1.53 7.27-4 9.8-2.54 2.59-6.08 4.2-10 4.2-7.73.0-14-6.27-14-14 0-7.73 6.27-14 14-14z"/><g class="rays" data-svg-origin="30 30"><line class="line" x1="30" y1="11" x2="30" y2="7"/><line class="line" x1="43.44" y1="16.57" x2="46.26" y2="13.74"/><line class="line" x1="49" y1="30" x2="53" y2="30"/><line class="line" x1="43.43" y1="43.44" x2="46.26" y2="46.26"/><line class="line" x1="30" y1="49" x2="30" y2="53"/><line class="line" x1="16.56" y1="43.43" x2="13.74" y2="46.26"/><line class="line" x1="11" y1="30" x2="7" y2="30"/><line class="line" x1="16.57" y1="16.56" x2="13.74" y2="13.74"/></g></svg><div class=push></div><a style=--url:url(./github.svg) href=https://github.com/lavafroth aria-label=github target=_blank></a><a href=../../about/ aria-label=about style=--url:url(./about.svg)></a><a href=../../art/ aria-label=art style=--url:url(./art.svg)></a><script>const bodyClx=document.body.classList,sysDark=window.matchMedia("(prefers-color-scheme: dark)"),darkVal=localStorage.getItem("dark"),setDark=e=>(bodyClx.toggle("dark",e),localStorage.setItem("dark",e));setDark(darkVal?darkVal==="true":sysDark.matches),requestAnimationFrame(()=>bodyClx.remove("not-ready")),btnDark.addEventListener("click",()=>setDark(!bodyClx.contains("dark"))),sysDark.addEventListener("change",({matches:e})=>setDark(e))</script></header><main class=main><article class=post-single><header class=post-title><p><time>Jun 10, 2024 | 3 minutes read</time></p><h1 data-pagefind-meta=title>Modes, Unbinds and Other Ensembled Parser Patterns</h1></header><section class=post-content data-pagefind-body><p>Hello and welcome to the sixth instalment in this series where we build a parser
for a domain specific language from scratch. I would highly recommend you to go
through the previous articles to make sense of what we&rsquo;ll talk about today.</p><p>So far, we have built ranges, shorthands and bindings, starting all the way down
from primitives such as keys and modifiers. Continuing with the theme, we will
ensemble these patterns together along with some newer syntax to build modes.</p><p>SWHKD allows us to define additional properties to one or more bindings
by wrapping them in mode blocks. These properties can describe whether
bindings are meant as <em>one-off</em> bindings that immediately exit a mode
or that they must <em>swallow</em> the keypresses and not emit any uinput events.</p><p>The syntax of a mode definition is akin to that of <code>if</code> statements in bash.
A mode block begins with the word <code>mode</code> and ends with the word <code>endmode</code>.
The keyword <code>mode</code> must be followed by a name for future reference
while debugging a config.</p><pre tabindex=0><code>mode my_mode_name
  # ...
  # bindings go here
  # ...
endmode
</code></pre><p>The mode name can be followed by one or more mode properties: <code>oneoff</code> and
<code>swallow</code> as we discussed earlier. Non unqiue properties get automatically
removed. Inside the mode, we can add one or more bindings, comments and unbinds.
Thus, an example mode block could look like the following:</p><pre tabindex=0><code>mode dir oneoff swallow
	{super, alt} + {ctrl, shift} + l
		{ls, exa} {\-a, \-A} -l

  ignore alt + l
endmode
</code></pre><p>Hold on, what is that <code>ignore</code> statement? Well, that is an unbind statement.
It is rather trivial to implement which is why it does not get its own section.
An unbind is a single statement that begins with ignore followed by the <code>trigger</code>
for a binding that we built in a previous article. It is modelled in the grammar
side simply as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>unbind <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#34;ignore&#34;</span> <span style=color:#f92672>~</span> trigger }
</span></span></code></pre></div><p>Coming back to modes, we define the oneoff and swallow expressions like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>oneoff  <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#34;oneoff&#34;</span> }
</span></span><span style=display:flex><span>swallow <span style=color:#f92672>=</span> { <span style=color:#e6db74>&#34;swallow&#34;</span> }
</span></span></code></pre></div><p>Due to the way EBNF greedily processes inputs, we need to make sure that the mode name
that comes before any of these properties do not accidentally also match them. To do this,
we have to explicitly negate the aforementioned expressions in the token (character) set for mode
names.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>modename_characters <span style=color:#f92672>=</span> _{ <span style=color:#960050;background-color:#1e0010>!</span>NEWLINE <span style=color:#f92672>~</span> <span style=color:#960050;background-color:#1e0010>!</span>(oneoff <span style=color:#f92672>|</span> swallow) <span style=color:#f92672>~</span> ANY }
</span></span></code></pre></div><p>We can now have one or more of these mode name characters build an entire mode name.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>modename <span style=color:#f92672>=</span> { modename_characters<span style=color:#f92672>+</span> }
</span></span></code></pre></div><p>For the contents inside a mode, we will create a union representation of comments, bindings
and unbinds as <code>primitives</code>. This facilitates easier reuse in future expressions.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>primitives <span style=color:#f92672>=</span> _{ comment <span style=color:#f92672>|</span> unbind <span style=color:#f92672>|</span> binding }
</span></span></code></pre></div><p>Since this is a expression catered towards convenience and we don&rsquo;t need it on
the code side, we have silenced it with a leading underscore. For the home stretch now,
let&rsquo;s put all of these smaller expressions together to build the mode expression itself.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>mode <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;mode&#34;</span> <span style=color:#f92672>~</span> modename <span style=color:#f92672>~</span> oneoff<span style=color:#960050;background-color:#1e0010>?</span> <span style=color:#f92672>~</span> swallow<span style=color:#960050;background-color:#1e0010>?</span> <span style=color:#f92672>~</span> comment<span style=color:#960050;background-color:#1e0010>?</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>~</span> NEWLINE <span style=color:#f92672>~</span> WHITESPACE<span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>~</span> (primitives <span style=color:#f92672>~</span> NEWLINE)<span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>~</span> <span style=color:#e6db74>&#34;endmode&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We started with the keyword <code>mode</code>, followed by a mode name, one or more properties and an optional comment.
Then we move onto the next line where there might be some whitespaces for visual structure and finally one or
more primitives (bindings, comments and unbinds) separated by newlines. Lastly, we end with the <code>endmode</code>
statement.</p><p>Note that we did not need to care about indentation when talking about modes since they have explicit markers
around their start and end.</p><p>Okay, that&rsquo;s about it for now, I&rsquo;ll see you in the next article.</p></section></article><footer class=post-tags data-pagefind-meta=tags><a href=https://lavafroth.is-a.dev/tags/ebnf class=list-tag>EBNF</a>
<a href=https://lavafroth.is-a.dev/tags/google-summer-of-code class=list-tag>Google Summer of Code</a>
<a href=https://lavafroth.is-a.dev/tags/rust class=list-tag>Rust</a>
<a href=https://lavafroth.is-a.dev/tags/swhkd class=list-tag>SWHKD</a>
<a href=https://lavafroth.is-a.dev/tags/waycrate class=list-tag>Waycrate</a>
<a href=https://lavafroth.is-a.dev/tags/wayland class=list-tag>Wayland</a></footer><nav class=post-nav><a class=prev href=https://lavafroth.is-a.dev/post/test-driven-development-the-pinnacle-of-engineering/><span>←</span><span>Test Driven Development - The Pinnacle of Engineering</span></a>
<a class=next href=https://lavafroth.is-a.dev/post/i-solemnly-swear-to-never-buy-a-gaming-laptop-again/><span>I Solemnly Swear to Never Buy a Gaming Laptop Again</span><span>→</span></a></nav></main><footer class=footer><p>&copy; 2025 <a href=https://lavafroth.is-a.dev/>lavafroth</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/issues/new/choose>Report an issue</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/discussions/>Discuss</a></p><p><a href=https://lavafroth.is-a.dev/privacy>Privacy</a></p><p><a href=https://creativecommons.org/licenses/by-sa/4.0/legalcode>License</a></p></footer></body></html>